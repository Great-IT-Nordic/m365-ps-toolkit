<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M365 PowerShell Toolkit</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-root: #06080d;
  --bg-surface: #0b0f18;
  --bg-card: #0f1420;
  --bg-elevated: #151b2b;
  --bg-code: #080b12;
  --border: #1a2035;
  --border-hover: #2a3555;
  --text-primary: #e4e8f0;
  --text-secondary: #7a8599;
  --text-dim: #4a5568;
  --accent: #3b82f6;
  --accent-glow: rgba(59,130,246,0.15);
  --green: #34d399;
  --green-glow: rgba(52,211,153,0.15);
  --amber: #f59e0b;
  --amber-glow: rgba(245,158,11,0.12);
  --red: #ef4444;
  --font-body: 'DM Sans', system-ui, sans-serif;
  --font-mono: 'IBM Plex Mono', 'Cascadia Code', 'Consolas', monospace;
  --radius: 10px;
  --radius-sm: 6px;
}
[data-theme="light"] {
  --bg-root: #f5f7fa;
  --bg-surface: #ffffff;
  --bg-card: #ffffff;
  --bg-elevated: #f0f2f5;
  --bg-code: #f6f8fa;
  --border: #d1d9e0;
  --border-hover: #a8b5c4;
  --text-primary: #1a202c;
  --text-secondary: #4a5568;
  --text-dim: #8899aa;
  --accent: #2563eb;
  --accent-glow: rgba(37,99,235,0.1);
  --green: #059669;
  --green-glow: rgba(5,150,105,0.1);
  --amber: #d97706;
  --amber-glow: rgba(217,119,6,0.08);
  --red: #dc2626;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: var(--bg-root); color: var(--text-primary); font-family: var(--font-body); line-height: 1.5; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.app { display: flex; min-height: 100vh; }
.sidebar {
  width: 280px;
  background: var(--bg-surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0; left: 0; bottom: 0;
  z-index: 50;
  transition: transform 0.3s;
}
.sidebar.hidden { transform: translateX(-100%); }
.main {
  flex: 1;
  margin-left: 280px;
  min-width: 0;
  transition: margin-left 0.3s;
}
.main.full { margin-left: 0; }

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar-header {
  padding: 20px 16px 16px;
  border-bottom: 1px solid var(--border);
}
.sidebar-logo {
  display: flex; align-items: center; gap: 10px;
  font-weight: 700; font-size: 16px; color: var(--text-primary);
  margin-bottom: 4px;
}
.sidebar-logo svg { color: var(--accent); }
.sidebar-sub { font-size: 11px; color: var(--text-dim); }
.sidebar-nav {
  flex: 1; overflow-y: auto; padding: 12px 8px;
}
.nav-section-title {
  font-size: 10px; font-weight: 600; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 1.5px;
  padding: 12px 12px 6px; user-select: none;
}
.nav-item {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 12px; border-radius: var(--radius-sm);
  font-size: 13px; color: var(--text-secondary);
  cursor: pointer; transition: all 0.15s; user-select: none;
  border: 1px solid transparent;
}
.nav-item:hover { background: var(--bg-elevated); color: var(--text-primary); }
.nav-item.active { background: var(--accent-glow); color: var(--accent); border-color: rgba(59,130,246,0.2); }
.nav-item .cnt {
  margin-left: auto; font-size: 10px; font-weight: 600;
  background: var(--bg-elevated); padding: 2px 6px; border-radius: 10px;
  color: var(--text-dim);
}
.nav-item.active .cnt { background: rgba(59,130,246,0.15); color: var(--accent); }

.sidebar-footer {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
}

/* ‚îÄ‚îÄ GLOBAL PARAMS BAR ‚îÄ‚îÄ */
.params-bar {
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  padding: 12px 24px;
  display: none;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
  animation: slideDown 0.2s ease;
}
.params-bar.visible { display: flex; }
.param-group { display: flex; align-items: center; gap: 6px; }
.param-group label {
  font-size: 11px; font-weight: 600; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;
}
.param-input {
  padding: 6px 10px;
  background: var(--bg-code);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--accent);
  font-size: 12px;
  font-family: var(--font-mono);
  outline: none;
  width: 180px;
}
.param-input:focus { border-color: var(--accent); }
.param-input::placeholder { color: var(--text-dim); }

/* ‚îÄ‚îÄ HEADER / TOOLBAR ‚îÄ‚îÄ */
.toolbar {
  display: flex; align-items: center; gap: 12px;
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-surface);
  position: sticky; top: 0; z-index: 40;
}
.toolbar-toggle {
  display: none;
  background: none; border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 6px 8px;
  color: var(--text-secondary); cursor: pointer;
}
.search-wrap { position: relative; flex: 1; max-width: 480px; }
.search-wrap svg {
  position: absolute; left: 12px; top: 50%;
  transform: translateY(-50%); color: var(--text-dim);
}
.search-input {
  width: 100%;
  padding: 10px 12px 10px 38px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-size: 13px; font-family: var(--font-body);
  outline: none; transition: border-color 0.15s;
}
.search-input:focus { border-color: var(--accent); }
.search-input::placeholder { color: var(--text-dim); }

.toolbar-actions { display: flex; gap: 8px; margin-left: auto; align-items: center; }
.tool-btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-secondary);
  font-size: 12px; font-family: var(--font-body); font-weight: 500;
  cursor: pointer; transition: all 0.15s; white-space: nowrap;
}
.tool-btn:hover { background: var(--bg-elevated); color: var(--text-primary); border-color: var(--border-hover); }
.tool-btn.active { background: var(--accent-glow); color: var(--accent); border-color: rgba(59,130,246,0.3); }
.tool-btn.green { background: var(--green-glow); color: var(--green); border-color: rgba(52,211,153,0.3); }
.tool-btn.green:hover { background: rgba(52,211,153,0.2); }
.badge {
  background: var(--accent);
  color: #fff;
  font-size: 10px; font-weight: 700;
  padding: 1px 6px; border-radius: 10px;
  min-width: 18px; text-align: center;
}

/* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
.content { padding: 20px 24px 80px; max-width: 1000px; }

/* Workflow Banner */
.workflow-banner {
  background: linear-gradient(135deg, var(--amber-glow), transparent);
  border: 1px solid rgba(245,158,11,0.2);
  border-radius: var(--radius);
  padding: 16px 20px;
  margin-bottom: 20px;
  display: none;
}
.workflow-banner.visible { display: block; }
.workflow-banner h3 {
  font-size: 15px; font-weight: 700;
  color: var(--amber); margin-bottom: 4px;
}
.workflow-banner p {
  font-size: 12px; color: var(--text-secondary);
  margin-bottom: 12px;
}
.workflow-steps {
  display: flex; flex-direction: column; gap: 4px;
}
.workflow-step {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 8px 12px; border-radius: var(--radius-sm);
  background: rgba(0,0,0,0.2);
}
.workflow-step-num {
  background: var(--amber);
  color: #000; font-size: 10px; font-weight: 700;
  width: 20px; height: 20px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; margin-top: 1px;
}
.workflow-step-text { font-size: 12px; color: var(--text-primary); }
.workflow-step-text .dim { color: var(--text-dim); }

/* Module Setup */
.module-panel {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px; margin-bottom: 24px;
  display: none;
}
.module-panel.visible { display: block; }
.module-panel h3 { font-size: 15px; font-weight: 700; margin-bottom: 2px; }
.module-panel .sub { font-size: 12px; color: var(--text-dim); margin-bottom: 14px; }
.mod-card {
  background: var(--bg-code);
  border: 1px solid var(--border);
  border-radius: 8px; padding: 12px;
  margin-bottom: 6px;
}
.mod-card-header {
  display: flex; justify-content: space-between;
  align-items: center; margin-bottom: 6px;
}
.mod-card-name { font-size: 12px; font-weight: 600; }
.mod-card-name .dim { font-weight: 400; color: var(--text-dim); }
.mod-btns { display: flex; gap: 6px; flex-wrap: wrap; }
.mod-card pre {
  font-family: var(--font-mono); font-size: 11px;
  color: var(--text-dim); white-space: pre-wrap; line-height: 1.5;
  margin: 0;
}

/* Category */
.cat-section { margin-bottom: 28px; }
.cat-title {
  font-size: 13px; font-weight: 700; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 1.5px;
  padding-bottom: 8px; margin-bottom: 8px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 8px;
}
.cat-title .cnt {
  font-size: 10px; font-weight: 500; letter-spacing: 0;
  text-transform: none;
}

/* Command Card */
.cmd-card {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-card);
  margin-bottom: 4px;
  border-left: 3px solid var(--text-dim);
  transition: all 0.15s;
}
.cmd-card:hover { border-color: var(--border-hover); border-left-color: inherit; }
.cmd-card.expanded { background: var(--bg-elevated); }
.cmd-card.favorited { box-shadow: inset 0 0 0 1px rgba(245,158,11,0.15); }
.cmd-header {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 14px; cursor: pointer; user-select: none;
}
.cmd-header:hover { background: rgba(255,255,255,0.015); border-radius: var(--radius); }
.cmd-check {
  width: 18px; height: 18px;
  border: 2px solid var(--border);
  border-radius: 4px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s; cursor: pointer;
}
.cmd-check.checked { background: var(--accent); border-color: var(--accent); }
.cmd-check.hidden { display: none; }
.fav-btn {
  background: none; border: none;
  color: var(--text-dim); cursor: pointer;
  padding: 2px; flex-shrink: 0;
  transition: color 0.15s;
}
.fav-btn:hover { color: var(--amber); }
.fav-btn.active { color: var(--amber); }
.chevron {
  transition: transform 0.2s; flex-shrink: 0;
  color: var(--text-dim);
}
.cmd-card.expanded .chevron { transform: rotate(90deg); }
.cmd-info { flex: 1; min-width: 0; }
.cmd-name-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.cmd-name { font-weight: 600; font-size: 13px; }
.cmd-badge {
  font-size: 9px; padding: 2px 7px; border-radius: 20px;
  font-weight: 600; letter-spacing: 0.3px;
  font-family: var(--font-mono);
}
.cmd-desc { font-size: 11px; color: var(--text-dim); margin-top: 1px; }
.cmd-detail {
  padding: 0 14px 12px;
  border-top: 1px solid var(--border);
  display: none;
}
.cmd-card.expanded .cmd-detail { display: block; }
.cmd-code {
  background: var(--bg-code);
  border: 1px solid var(--border);
  border-radius: 8px; padding: 14px;
  margin-top: 10px;
  font-family: var(--font-mono);
  font-size: 12px; color: var(--text-primary);
  overflow-x: auto; white-space: pre-wrap;
  line-height: 1.7; position: relative;
}
.cmd-code .copy-float { position: absolute; top: 8px; right: 8px; }
.cmd-mod-row {
  display: flex; gap: 8px; margin-top: 10px;
  flex-wrap: wrap; align-items: center;
}
.cmd-mod-row .lbl { font-size: 11px; color: var(--text-dim); }
.cmd-mod-row code {
  font-family: var(--font-mono);
  font-size: 11px; background: var(--bg-code);
  padding: 2px 8px; border-radius: 4px;
}

/* Copy Button */
.cb {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 4px 10px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-code);
  color: var(--text-dim);
  font-size: 11px; font-family: var(--font-body); font-weight: 500;
  cursor: pointer; transition: all 0.15s; white-space: nowrap;
}
.cb:hover { background: var(--bg-elevated); color: var(--text-secondary); border-color: var(--border-hover); }
.cb.copied { color: var(--green); border-color: rgba(52,211,153,0.3); }

/* Script Builder Drawer */
.builder-drawer {
  position: fixed; bottom: 0; left: 280px; right: 0;
  background: var(--bg-surface);
  border-top: 2px solid var(--accent);
  padding: 16px 24px;
  z-index: 45;
  transform: translateY(100%);
  transition: transform 0.3s ease;
  max-height: 50vh; overflow-y: auto;
}
.builder-drawer.visible { transform: translateY(0); }
.content.builder-active { padding-bottom: 360px; }
.builder-drawer.full-width { left: 0; }
.builder-header {
  display: flex; justify-content: space-between;
  align-items: center; margin-bottom: 12px;
}
.builder-header h3 { font-size: 15px; font-weight: 700; color: var(--accent); }
.builder-preview {
  background: var(--bg-code);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-primary);
  white-space: pre-wrap;
  line-height: 1.6;
  max-height: 250px;
  overflow-y: auto;
}
.builder-actions { display: flex; gap: 8px; margin-top: 12px; }

/* Empty */
.empty {
  text-align: center; padding: 60px 20px; color: var(--text-dim);
}
.empty .icon { font-size: 40px; margin-bottom: 10px; opacity: 0.5; }
.empty .title { font-size: 15px; color: var(--text-secondary); }
.empty .sub { font-size: 12px; margin-top: 4px; }

/* How to Use Guide */
.guide-toggle {
  display: flex; align-items: center; gap: 8px; padding: 12px 16px;
  background: var(--bg-elevated); border: 1px solid var(--border);
  border-radius: var(--radius); cursor: pointer; margin-bottom: 20px;
  transition: all 0.2s;
}
.guide-toggle:hover { border-color: var(--accent); background: var(--accent-glow); }
.guide-toggle .guide-icon { font-size: 18px; }
.guide-toggle .guide-label { font-size: 14px; font-weight: 600; color: var(--text-primary); }
.guide-toggle .guide-sub { font-size: 12px; color: var(--text-secondary); margin-left: auto; }
.guide-toggle .guide-chevron { color: var(--text-dim); transition: transform 0.2s; }
.guide-toggle.open .guide-chevron { transform: rotate(90deg); }
.guide-panel {
  display: none; background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 24px; margin-bottom: 24px; margin-top: -12px;
  animation: slideDown 0.2s ease;
}
.guide-panel.visible { display: block; }
.guide-panel h3 { font-size: 15px; font-weight: 700; color: var(--accent); margin-bottom: 12px; }
.guide-panel h4 { font-size: 13px; font-weight: 600; color: var(--text-primary); margin: 16px 0 8px; }
.guide-panel p, .guide-panel li { font-size: 13px; color: var(--text-secondary); line-height: 1.7; }
.guide-panel ul { padding-left: 18px; }
.guide-panel li { margin-bottom: 4px; }
.guide-panel code { font-family: var(--font-mono); font-size: 12px; background: var(--bg-code); padding: 2px 6px; border-radius: 4px; color: var(--green); }
.guide-panel .guide-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; margin-top: 12px; }
.guide-panel .guide-card { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px; }
.guide-panel .guide-card .num { font-size: 20px; font-weight: 700; color: var(--accent); opacity: 0.5; }
.guide-panel .guide-card .gc-title { font-size: 13px; font-weight: 600; color: var(--text-primary); margin: 4px 0; }
.guide-panel .guide-card .gc-text { font-size: 12px; color: var(--text-dim); }

/* Doc links */
.doc-link {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 11px; color: var(--accent); text-decoration: none;
  padding: 3px 8px; border-radius: 4px; background: var(--accent-glow);
  transition: all 0.2s; margin-left: 6px;
}
.doc-link:hover { background: rgba(59,130,246,0.25); color: #60a5fa; }
.doc-link svg { flex-shrink: 0; }

/* Builder mode indicator */
.builder-indicator {
  display: none; padding: 8px 16px; background: rgba(59,130,246,0.08);
  border: 1px solid rgba(59,130,246,0.2); border-radius: var(--radius-sm);
  margin-bottom: 16px; font-size: 12px; color: var(--accent);
  align-items: center; gap: 8px;
}
.builder-indicator.visible { display: flex; }
.builder-indicator .pulse { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); animation: pulse 1.5s infinite; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

/* Footer */
.app-footer {
  padding: 24px; border-top: 1px solid var(--border);
  text-align: center; font-size: 11px; color: var(--text-dim);
}
.app-footer a { color: var(--text-secondary); text-decoration: none; }
.app-footer a:hover { color: var(--accent); }

/* Risk indicators */
.risk-badge {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 10px; font-weight: 600; padding: 2px 7px;
  border-radius: 4px; letter-spacing: 0.3px; text-transform: uppercase;
  flex-shrink: 0;
}
.risk-read { background: rgba(52,211,153,0.12); color: #34d399; border: 1px solid rgba(52,211,153,0.25); }
.risk-modify { background: rgba(245,158,11,0.1); color: #f59e0b; border: 1px solid rgba(245,158,11,0.2); }
.risk-destructive { background: rgba(239,68,68,0.1); color: #ef4444; border: 1px solid rgba(239,68,68,0.2); }
.risk-dot { width: 6px; height: 6px; border-radius: 50%; }
.risk-read .risk-dot { background: #34d399; }
.risk-modify .risk-dot { background: #f59e0b; }
.risk-destructive .risk-dot { background: #ef4444; }

/* Permissions badge */
.perm-row {
  display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px;
  align-items: center;
}
.perm-row .lbl { font-size: 11px; color: var(--text-dim); margin-right: 2px; }
.perm-tag {
  font-size: 10px; font-family: var(--font-mono);
  padding: 2px 8px; border-radius: 4px;
  background: rgba(98,100,167,0.12); color: #8b8ece;
  border: 1px solid rgba(98,100,167,0.2);
}

/* Builder options */
.builder-opts {
  display: flex; flex-wrap: wrap; gap: 12px; padding: 10px 0;
  margin-bottom: 10px; border-bottom: 1px solid var(--border);
}
.builder-opt {
  display: flex; align-items: center; gap: 6px;
  font-size: 12px; color: var(--text-secondary); cursor: pointer;
  user-select: none;
}
.builder-opt input[type="checkbox"] {
  accent-color: var(--accent); width: 14px; height: 14px; cursor: pointer;
}
.builder-opt:hover { color: var(--text-primary); }
.builder-opt .opt-hint {
  font-size: 10px; color: var(--text-dim); font-style: italic;
}

/* Admin portals grid */
.portals-section {
  margin-bottom: 20px;
}
.portals-toggle {
  display: flex; align-items: center; gap: 8px; padding: 12px 16px;
  background: var(--bg-elevated); border: 1px solid var(--border);
  border-radius: var(--radius); cursor: pointer;
  transition: all 0.2s;
}
.portals-toggle:hover { border-color: var(--accent); background: var(--accent-glow); }
.portals-toggle .portals-icon { font-size: 18px; }
.portals-toggle .portals-label { font-size: 14px; font-weight: 600; color: var(--text-primary); }
.portals-toggle .portals-sub { font-size: 12px; color: var(--text-secondary); margin-left: auto; }
.portals-toggle .portals-chevron { color: var(--text-dim); transition: transform 0.2s; }
.portals-toggle.open .portals-chevron { transform: rotate(90deg); }
.portals-panel {
  display: none; margin-top: -1px; margin-bottom: 20px;
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 0 0 var(--radius) var(--radius);
  padding: 16px; animation: slideDown 0.2s ease;
}
.portals-panel.visible { display: block; }
.portals-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 8px;
}
.portal-card {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; border-radius: var(--radius-sm);
  background: var(--bg-elevated); border: 1px solid var(--border);
  text-decoration: none; transition: all 0.2s;
}
.portal-card:hover { border-color: var(--accent); background: var(--accent-glow); transform: translateY(-1px); }
.portal-card .p-icon { font-size: 20px; flex-shrink: 0; }
.portal-card .p-name { font-size: 12px; font-weight: 600; color: var(--text-primary); }
.portal-card .p-url { font-size: 10px; color: var(--text-dim); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* Tenant Profiles */
.profile-section {
  display: flex; align-items: center; gap: 8px; margin-right: 12px;
  padding-right: 12px; border-right: 1px solid var(--border);
}
.profile-select {
  background: var(--bg-elevated); color: var(--text-primary);
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  padding: 4px 8px; font-size: 12px; font-family: var(--font-body);
  cursor: pointer; min-width: 120px;
}
.profile-select:focus { outline: none; border-color: var(--accent); }
.profile-btn {
  background: none; border: 1px solid var(--border); border-radius: var(--radius-sm);
  color: var(--text-secondary); cursor: pointer; padding: 4px 8px;
  font-size: 11px; font-family: var(--font-body); transition: all 0.2s;
  display: flex; align-items: center; gap: 4px;
}
.profile-btn:hover { border-color: var(--accent); color: var(--accent); }
.profile-btn.danger:hover { border-color: var(--red); color: var(--red); }

/* Related commands */
.related-row {
  display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; padding-top: 10px;
  border-top: 1px solid var(--border);
}
.related-row .lbl { font-size: 11px; color: var(--text-dim); margin-right: 2px; width: 100%; margin-bottom: 2px; }
.related-chip {
  font-size: 11px; padding: 3px 10px; border-radius: 20px;
  background: var(--accent-glow); color: var(--accent);
  border: 1px solid rgba(59,130,246,0.2); cursor: pointer;
  transition: all 0.2s; text-decoration: none;
}
.related-chip:hover { background: rgba(59,130,246,0.25); border-color: var(--accent); }

/* CSV template */
.csv-btn {
  display: inline-flex; align-items: center; gap: 5px;
  font-size: 11px; padding: 4px 10px; border-radius: var(--radius-sm);
  background: var(--green-glow); color: var(--green);
  border: 1px solid rgba(52,211,153,0.25); cursor: pointer;
  font-family: var(--font-body); transition: all 0.2s;
}
.csv-btn:hover { background: rgba(52,211,153,0.25); }

/* Theme toggle */
.theme-toggle {
  background: none; border: 1px solid var(--border); border-radius: var(--radius-sm);
  color: var(--text-secondary); cursor: pointer; padding: 6px 8px;
  font-size: 14px; transition: all 0.2s; display: flex; align-items: center;
  margin-left: 8px;
}
.theme-toggle:hover { border-color: var(--accent); color: var(--accent); }

/* Guide section expansion */
.guide-panel h4 { margin-top: 18px; margin-bottom: 8px; color: var(--text-primary); font-size: 14px; }
.guide-panel h4:first-of-type { margin-top: 20px; }
.guide-panel .guide-section {
  background: var(--bg-elevated); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 14px 16px; margin-bottom: 10px;
}
.guide-panel .guide-section h5 {
  font-size: 13px; color: var(--accent); margin-bottom: 6px;
}
.guide-panel .guide-section p, .guide-panel .guide-section li {
  font-size: 12px; color: var(--text-secondary); line-height: 1.7;
}
.guide-panel .guide-section code {
  background: var(--bg-code); padding: 2px 6px; border-radius: 3px;
  font-family: var(--font-mono); font-size: 11px;
}
.guide-panel .guide-section pre {
  background: var(--bg-code); padding: 10px 14px; border-radius: var(--radius-sm);
  border: 1px solid var(--border); font-family: var(--font-mono);
  font-size: 11px; color: var(--text-primary); overflow-x: auto;
  margin: 8px 0; line-height: 1.6;
}
.guide-tabs {
  display: flex; gap: 0; margin-bottom: 16px; border-bottom: 1px solid var(--border);
}
.guide-tab {
  padding: 8px 16px; font-size: 12px; font-weight: 600; cursor: pointer;
  color: var(--text-dim); border-bottom: 2px solid transparent;
  transition: all 0.2s; background: none; border-top: none; border-left: none; border-right: none;
  font-family: var(--font-body);
}
.guide-tab:hover { color: var(--text-secondary); }
.guide-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.guide-tab-content { display: none; animation: fadeIn 0.2s ease; }
.guide-tab-content.active { display: block; }

/* Animations */
@keyframes slideDown {
  from { opacity: 0; transform: translateY(-8px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
.cat-section { animation: fadeIn 0.2s ease; }

/* Responsive */
@media (max-width: 860px) {
  .sidebar { transform: translateX(-100%); }
  .sidebar.visible { transform: translateX(0); }
  .main { margin-left: 0 !important; }
  .toolbar-toggle { display: flex; }
  .builder-drawer { left: 0 !important; }
  .content { padding: 16px 16px 80px; }
  .toolbar { padding: 12px 16px; }
  .params-bar { padding: 10px 16px; }
}
</style>
</head>
<body>

<div class="app">
  <!-- SIDEBAR -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
        M365 PS Toolkit
      </div>
      <div class="sidebar-sub" id="sidebarSub"></div>
    </div>
    <div class="sidebar-nav" id="sidebarNav"></div>
    <div class="sidebar-footer">
      <div class="tool-btn" onclick="toggleModulePanel()" style="width:100%;justify-content:center;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18m0-18l-4 4m4-4l4 4M4 21h16"/></svg>
        Module Setup
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <div class="main" id="main">
    <!-- Params bar -->
    <div class="params-bar" id="paramsBar">
      <div class="profile-section">
        <select class="profile-select" id="profileSelect" onchange="loadProfile()">
          <option value="">‚Äî Select tenant ‚Äî</option>
        </select>
        <button class="profile-btn" onclick="saveProfile()" title="Save current values as profile">üíæ Save</button>
        <button class="profile-btn danger" onclick="deleteProfile()" title="Delete selected profile">üóëÔ∏è</button>
      </div>
      <div class="param-group">
        <label>Domain</label>
        <input class="param-input" id="paramDomain" placeholder="contoso.com" oninput="renderCommands()">
      </div>
      <div class="param-group">
        <label>Admin UPN</label>
        <input class="param-input" id="paramAdmin" placeholder="admin@contoso.com" oninput="renderCommands()">
      </div>
      <div class="param-group">
        <label>SPO URL</label>
        <input class="param-input" id="paramSPO" placeholder="contoso-admin.sharepoint.com" style="width:220px" oninput="renderCommands()">
      </div>
      <div class="tool-btn" onclick="toggleParams()" style="margin-left:auto">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        Close
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <button class="toolbar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <div class="search-wrap">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input class="search-input" id="searchInput" placeholder="Search commands... (Ctrl+K)" oninput="onSearch()">
      </div>
      <div class="toolbar-actions">
        <button class="tool-btn" id="paramToggle" onclick="toggleParams()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          Parameters
        </button>
        <button class="tool-btn" id="builderToggle" onclick="toggleBuilderMode()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          Script Builder
        </button>
        <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle light/dark theme">üåô</button>
      </div>
    </div>

    <!-- Content -->
    <div class="content" id="content">
      <!-- How to Use Guide -->
      <div class="guide-toggle" id="guideToggle" onclick="toggleGuide()">
        <span class="guide-icon">üìñ</span>
        <span class="guide-label">Getting Started</span>
        <span class="guide-sub">How to use this toolkit</span>
        <svg class="guide-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
      <div class="guide-panel" id="guidePanel">
        <h3>Welcome to the M365 PowerShell Toolkit</h3>
        <p>A comprehensive reference for managing Microsoft 365 via PowerShell. All commands work with <strong>PowerShell 7+</strong> and the latest Graph / Exchange modules.</p>

        <div class="guide-tabs">
          <button class="guide-tab active" onclick="switchGuideTab('quickstart',this)">Quick Start</button>
          <button class="guide-tab" onclick="switchGuideTab('prerequisites',this)">Prerequisites</button>
          <button class="guide-tab" onclick="switchGuideTab('features',this)">Features</button>
          <button class="guide-tab" onclick="switchGuideTab('troubleshooting',this)">Troubleshooting</button>
          <button class="guide-tab" onclick="switchGuideTab('tips',this)">Tips & Shortcuts</button>
        </div>

        <!-- Quick Start Tab -->
        <div class="guide-tab-content active" id="tab-quickstart">
          <div class="guide-grid">
            <div class="guide-card"><div class="num">01</div><div class="gc-title">Install Modules</div><div class="gc-text">Click any module badge ‚Üí copy the <code>Install</code> command. Run in an elevated PowerShell session.</div></div>
            <div class="guide-card"><div class="num">02</div><div class="gc-title">Set Parameters</div><div class="gc-text">Click <strong>‚öôÔ∏è Parameters</strong> and enter your domain. All commands auto-update with your values. Save it as a tenant profile for quick switching.</div></div>
            <div class="guide-card"><div class="num">03</div><div class="gc-title">Connect</div><div class="gc-text">Use the <code>Connect</code> button on any module card. Most modules support modern auth ‚Äî a browser window will open.</div></div>
            <div class="guide-card"><div class="num">04</div><div class="gc-title">Run Commands</div><div class="gc-text">Search or browse by category. Expand any command to see full syntax, permissions required, and related commands.</div></div>
          </div>

          <div class="guide-section">
            <h5>Your first script in 60 seconds</h5>
            <pre># 1. Install the Microsoft Graph module (one-time)
Install-Module Microsoft.Graph -Scope CurrentUser

# 2. Connect (opens browser auth)
Connect-MgGraph -Scopes "User.Read.All"

# 3. List all users
Get-MgUser -All | Select DisplayName, UserPrincipalName, AccountEnabled

# 4. Disconnect when done
Disconnect-MgGraph</pre>
          </div>
        </div>

        <!-- Prerequisites Tab -->
        <div class="guide-tab-content" id="tab-prerequisites">
          <div class="guide-section">
            <h5>System Requirements</h5>
            <ul>
              <li><strong>PowerShell 7+</strong> ‚Äî Download from <a href="https://github.com/PowerShell/PowerShell/releases" target="_blank" class="doc-link">github.com/PowerShell <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a>. Windows PowerShell 5.1 works for most Exchange/SPO cmdlets, but Graph requires PS7.</li>
              <li><strong>Admin permissions</strong> ‚Äî Most commands require Global Admin, Exchange Admin, or Teams Admin roles. Check the <em>Permissions</em> shown per command.</li>
              <li><strong>.NET Runtime</strong> ‚Äî Comes with PowerShell 7. No separate install needed.</li>
            </ul>
          </div>
          <div class="guide-section">
            <h5>Module Installation</h5>
            <p>Install all modules at once (run as administrator):</p>
            <pre># Core modules
Install-Module Microsoft.Graph -Scope CurrentUser -Force
Install-Module ExchangeOnlineManagement -Scope CurrentUser -Force
Install-Module MicrosoftTeams -Scope CurrentUser -Force
Install-Module Microsoft.Online.SharePoint.PowerShell -Scope CurrentUser -Force
Install-Module PnP.PowerShell -Scope CurrentUser -Force</pre>
            <p style="margin-top:8px">Or click <strong>"Module Setup"</strong> in the sidebar footer for an interactive per-module setup panel with copy buttons.</p>
          </div>
          <div class="guide-section">
            <h5>Authentication Methods</h5>
            <ul>
              <li><strong>Interactive (default)</strong> ‚Äî Opens a browser window for MFA-compatible sign-in. Best for ad-hoc admin tasks.</li>
              <li><strong>Certificate-based</strong> ‚Äî For unattended/scheduled scripts. Requires an Entra App Registration with a certificate. Use <code>Connect-MgGraph -ClientId "..." -TenantId "..." -CertificateThumbprint "..."</code></li>
              <li><strong>Managed Identity</strong> ‚Äî For Azure Functions or Azure Automation. Use <code>Connect-MgGraph -Identity</code></li>
            </ul>
          </div>
        </div>

        <!-- Features Tab -->
        <div class="guide-tab-content" id="tab-features">
          <div class="guide-section">
            <h5>üè¢ Tenant Profiles</h5>
            <p>Working with multiple clients? Open <strong>Parameters</strong>, fill in the domain/admin/SPO for a client, and click <strong>üíæ Save</strong> to create a named profile. Switch between tenants instantly with the dropdown.</p>
          </div>
          <div class="guide-section">
            <h5>üìã Script Builder</h5>
            <p>Toggle <strong>Script Builder</strong> in the toolbar. Check the commands you need ‚Üí they're combined into a ready-to-run .ps1 script in the panel below. Options include:</p>
            <ul>
              <li><strong>Safe import</strong> ‚Äî Only installs modules if not already present</li>
              <li><strong>Error handling</strong> ‚Äî Wraps commands in try/catch/finally</li>
              <li><strong>Transcript logging</strong> ‚Äî Logs everything to a timestamped file</li>
              <li><strong>Download as .ps1</strong> ‚Äî Save directly as a script file</li>
            </ul>
          </div>
          <div class="guide-section">
            <h5>üìä Workflow Templates</h5>
            <p>Pre-built, step-by-step checklists for common admin tasks. Each workflow shows the procedure and links to the exact commands needed. Available workflows: User Onboarding, Offboarding, Security Audit, Tenant Review, License Cleanup, Mail Hygiene, and Guest Access Audit.</p>
          </div>
          <div class="guide-section">
            <h5>üîç Smart Search</h5>
            <p>Search finds matches across command names, descriptions, PowerShell syntax, and module names. Use <code>Ctrl+K</code> from anywhere. Filter by category, module, or workflow in the sidebar.</p>
          </div>
          <div class="guide-section">
            <h5>üü¢üü°üî¥ Risk Indicators</h5>
            <p>Every command is tagged: <strong style="color:#34d399">Read</strong> (safe), <strong style="color:#f59e0b">Modify</strong> (changes settings), or <strong style="color:#ef4444">Destructive</strong> (deletes data). Know what you're running before you run it.</p>
          </div>
          <div class="guide-section">
            <h5>üîó Deep Links</h5>
            <p>Share specific views with your team. The URL updates as you navigate. Copy the URL to link directly to a category, workflow, or search result. Example: <code>?filter=Security%20%26%20Compliance</code></p>
          </div>
        </div>

        <!-- Troubleshooting Tab -->
        <div class="guide-tab-content" id="tab-troubleshooting">
          <div class="guide-section">
            <h5>‚ùå "The term 'Connect-MgGraph' is not recognized"</h5>
            <p>The Microsoft.Graph module isn't installed. Run:</p>
            <pre>Install-Module Microsoft.Graph -Scope CurrentUser -Force</pre>
            <p>Then restart your PowerShell session.</p>
          </div>
          <div class="guide-section">
            <h5>‚ùå "Insufficient privileges to complete the operation"</h5>
            <p>Your account doesn't have the required admin role, or the Graph scopes weren't granted. Reconnect with the correct scopes:</p>
            <pre>Connect-MgGraph -Scopes "User.ReadWrite.All","Directory.ReadWrite.All"</pre>
            <p>Check the <strong>Permissions</strong> tag on each command to see what scopes are needed.</p>
          </div>
          <div class="guide-section">
            <h5>‚ùå "Connect-ExchangeOnline: Access Denied"</h5>
            <p>Common causes: your account needs the Exchange Administrator role (or at minimum a recipient management role), Conditional Access policies may be blocking the connection, or you're connecting from a non-compliant device. Try:</p>
            <pre># Check your role assignments in Entra
Get-MgRoleManagement -DirectoryRoleAssignment | Where-Object {$_.PrincipalId -eq "your-object-id"}</pre>
          </div>
          <div class="guide-section">
            <h5>‚ùå "Get-MgUser: Only returns 100 users"</h5>
            <p>By default, Graph cmdlets return the first page (100 items). Always use the <code>-All</code> parameter for complete results:</p>
            <pre>Get-MgUser -All    # Returns ALL users, not just 100</pre>
          </div>
          <div class="guide-section">
            <h5>‚ùå Module version conflicts</h5>
            <p>If you see odd errors after an update, clean up old versions:</p>
            <pre># List all installed versions
Get-Module Microsoft.Graph -ListAvailable

# Remove old versions
Get-Module Microsoft.Graph -ListAvailable | Where-Object {$_.Version -ne (Get-Module Microsoft.Graph -ListAvailable | Sort-Object Version -Descending | Select-Object -First 1).Version} | Uninstall-Module -Force</pre>
          </div>
          <div class="guide-section">
            <h5>‚ùå "Running scripts is disabled on this system"</h5>
            <p>PowerShell's execution policy is blocking scripts. Run this in an elevated PowerShell:</p>
            <pre>Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser</pre>
          </div>
        </div>

        <!-- Tips & Shortcuts Tab -->
        <div class="guide-tab-content" id="tab-tips">
          <div class="guide-section">
            <h5>‚å®Ô∏è Keyboard Shortcuts</h5>
            <ul>
              <li><code>Ctrl+K</code> ‚Äî Jump to search from anywhere</li>
              <li><code>Escape</code> ‚Äî Close panels, blur search</li>
              <li><code>Ctrl+C</code> ‚Äî Copy from any code block (native)</li>
            </ul>
          </div>
          <div class="guide-section">
            <h5>üí° Power User Tips</h5>
            <ul>
              <li>‚≠ê <strong>Star your daily-drivers</strong> ‚Äî your favorites persist across sessions and show up in the sidebar for instant access</li>
              <li>üè¢ <strong>Save tenant profiles</strong> ‚Äî if you manage multiple clients, save each as a profile to switch instantly</li>
              <li>üìã <strong>Use Script Builder for runbooks</strong> ‚Äî select all commands for a procedure, enable error handling + transcript, and download as .ps1</li>
              <li>üîó <strong>Share links</strong> ‚Äî the URL updates as you navigate. Send a link to a colleague to point them at the exact workflow or category</li>
              <li>üìä <strong>CSV templates</strong> ‚Äî for bulk operation commands, click "üì• CSV Template" to download a ready-to-fill template</li>
              <li>üõ°Ô∏è <strong>Check risk level</strong> ‚Äî before running a command, glance at the risk badge. Red = destructive, test in a sandbox first</li>
            </ul>
          </div>
          <div class="guide-section">
            <h5>üîÑ Common Patterns</h5>
            <pre># Export any command output to CSV
Get-MgUser -All | Export-Csv "users.csv" -NoTypeInformation

# Filter with Where-Object
Get-MgUser -All | Where-Object {$_.Department -eq "IT"}

# Select specific properties
Get-MgUser -All -Property DisplayName,Mail,JobTitle | Select DisplayName,Mail,JobTitle

# Pipe to ForEach for bulk actions
Import-Csv "users.csv" | ForEach-Object {
    Update-MgUser -UserId $_.UserPrincipalName -Department $_.Department
}</pre>
          </div>
        </div>

        <h4>üìö Microsoft Documentation</h4>
        <ul>
          <li><a href="https://learn.microsoft.com/en-us/powershell/microsoftgraph/overview" target="_blank" class="doc-link">Microsoft Graph PowerShell <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a></li>
          <li><a href="https://learn.microsoft.com/en-us/powershell/exchange/exchange-online-powershell" target="_blank" class="doc-link">Exchange Online PowerShell <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a></li>
          <li><a href="https://learn.microsoft.com/en-us/microsoftteams/teams-powershell-overview" target="_blank" class="doc-link">Microsoft Teams PowerShell <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a></li>
          <li><a href="https://learn.microsoft.com/en-us/powershell/sharepoint/sharepoint-online/connect-sharepoint-online" target="_blank" class="doc-link">SharePoint Online PowerShell <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a></li>
          <li><a href="https://pnp.github.io/powershell/" target="_blank" class="doc-link">PnP PowerShell <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a></li>
          <li><a href="https://learn.microsoft.com/en-us/graph/api/overview" target="_blank" class="doc-link">Microsoft Graph API Reference <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a></li>
        </ul>
      </div>

      <!-- Admin Portals -->
      <div class="portals-section">
        <div class="portals-toggle" id="portalsToggle" onclick="togglePortals()">
          <span class="portals-icon">üåê</span>
          <span class="portals-label">Admin Portals</span>
          <span class="portals-sub">Quick links to all M365 admin centers</span>
          <svg class="portals-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="portals-panel" id="portalsPanel">
          <div class="portals-grid">
            <a href="https://admin.microsoft.com" target="_blank" class="portal-card"><span class="p-icon">üè¢</span><div><div class="p-name">Microsoft 365 Admin</div><div class="p-url">admin.microsoft.com</div></div></a>
            <a href="https://entra.microsoft.com" target="_blank" class="portal-card"><span class="p-icon">üîë</span><div><div class="p-name">Microsoft Entra</div><div class="p-url">entra.microsoft.com</div></div></a>
            <a href="https://admin.exchange.microsoft.com" target="_blank" class="portal-card"><span class="p-icon">üìß</span><div><div class="p-name">Exchange Admin</div><div class="p-url">admin.exchange.microsoft.com</div></div></a>
            <a href="https://admin.teams.microsoft.com" target="_blank" class="portal-card"><span class="p-icon">üí¨</span><div><div class="p-name">Teams Admin</div><div class="p-url">admin.teams.microsoft.com</div></div></a>
            <a href="https://intune.microsoft.com" target="_blank" class="portal-card"><span class="p-icon">üì±</span><div><div class="p-name">Intune / Endpoint</div><div class="p-url">intune.microsoft.com</div></div></a>
            <a href="https://security.microsoft.com" target="_blank" class="portal-card"><span class="p-icon">üõ°Ô∏è</span><div><div class="p-name">Security Center</div><div class="p-url">security.microsoft.com</div></div></a>
            <a href="https://compliance.microsoft.com" target="_blank" class="portal-card"><span class="p-icon">üìã</span><div><div class="p-name">Compliance / Purview</div><div class="p-url">compliance.microsoft.com</div></div></a>
            <a href="https://admin.powerplatform.microsoft.com" target="_blank" class="portal-card"><span class="p-icon">‚ö°</span><div><div class="p-name">Power Platform</div><div class="p-url">admin.powerplatform.microsoft.com</div></div></a>
            <a href="https://portal.azure.com" target="_blank" class="portal-card"><span class="p-icon">‚òÅÔ∏è</span><div><div class="p-name">Azure Portal</div><div class="p-url">portal.azure.com</div></div></a>
            <a href="https://developer.microsoft.com/en-us/graph/graph-explorer" target="_blank" class="portal-card"><span class="p-icon">üìä</span><div><div class="p-name">Graph Explorer</div><div class="p-url">developer.microsoft.com</div></div></a>
          </div>
        </div>
      </div>
      <div class="builder-indicator" id="builderIndicator">
        <span class="pulse"></span>
        <span><strong>Script Builder active</strong> ‚Äî Check commands to add them to your script. View the script in the panel below.</span>
      </div>

      <div class="module-panel" id="modulePanel"></div>
      <div class="workflow-banner" id="workflowBanner"></div>
      <div id="commandsContainer"></div>

      <!-- Footer -->
      <div class="app-footer">
        M365 PowerShell Toolkit v1.3 ¬∑ <a href="https://github.com/Great-IT-Nordic/m365-ps-toolkit" target="_blank">GitHub</a> ¬∑ 
        Built by <a href="https://github.com/Great-IT-Nordic" target="_blank">Great IT Nordic</a> ¬∑ 
        MIT License
      </div>
    </div>

    <!-- Builder Drawer -->
    <div class="builder-drawer" id="builderDrawer">
      <div class="builder-header">
        <h3>üìã Script Builder ‚Äî <span id="builderCount">0</span> commands selected</h3>
        <div style="display:flex;gap:8px">
          <button class="tool-btn" onclick="clearBuilder()">Clear All</button>
          <button class="tool-btn" onclick="toggleBuilderDrawer()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      </div>
      <div class="builder-preview" id="builderPreview">No commands selected yet. Enable Script Builder mode and check the commands you want to include.</div>
      <div class="builder-opts" id="builderOpts">
        <label class="builder-opt"><input type="checkbox" id="optSafeImport" checked onchange="updateBuilder()"> Safe import <span class="opt-hint">(check before install)</span></label>
        <label class="builder-opt"><input type="checkbox" id="optDisconnect" checked onchange="updateBuilder()"> Disconnect at end</label>
        <label class="builder-opt"><input type="checkbox" id="optErrorHandling" onchange="updateBuilder()"> Error handling <span class="opt-hint">(try/catch)</span></label>
        <label class="builder-opt"><input type="checkbox" id="optRequires" onchange="updateBuilder()"> #Requires -Version 7</label>
        <label class="builder-opt"><input type="checkbox" id="optTranscript" onchange="updateBuilder()"> Transcript logging</label>
      </div>
      <div class="builder-actions">
        <button class="tool-btn green" onclick="downloadScript()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Download .ps1
        </button>
        <button class="tool-btn" onclick="copyScript()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
          Copy to Clipboard
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const MODULES = {
  "ExchangeOnlineManagement": { install: "Install-Module -Name ExchangeOnlineManagement -Force", connect: "Connect-ExchangeOnline -UserPrincipalName {{admin}}", disconnect: "Disconnect-ExchangeOnline -Confirm:$false", color: "#0078D4", short: "EXO", docs: "https://learn.microsoft.com/en-us/powershell/exchange/exchange-online-powershell" },
  "Microsoft.Graph": { install: "Install-Module -Name Microsoft.Graph -Force", connect: "Connect-MgGraph -Scopes 'User.ReadWrite.All','Group.ReadWrite.All'", disconnect: "Disconnect-MgGraph", color: "#6264A7", short: "Graph", docs: "https://learn.microsoft.com/en-us/powershell/microsoftgraph/overview" },
  "MicrosoftTeams": { install: "Install-Module -Name MicrosoftTeams -Force", connect: "Connect-MicrosoftTeams", disconnect: "Disconnect-MicrosoftTeams", color: "#464EB8", short: "Teams", docs: "https://learn.microsoft.com/en-us/microsoftteams/teams-powershell-overview" },
  "Microsoft.Online.SharePoint.PowerShell": { install: "Install-Module -Name Microsoft.Online.SharePoint.PowerShell -Force", connect: "Connect-SPOService -Url https://{{spo}}", disconnect: "Disconnect-SPOService", color: "#038387", short: "SPO", docs: "https://learn.microsoft.com/en-us/powershell/sharepoint/sharepoint-online/connect-sharepoint-online" },
  "PnP.PowerShell": { install: "Install-Module -Name PnP.PowerShell -Force", connect: "Connect-PnPOnline -Url https://{{domain}}.sharepoint.com -Interactive", disconnect: "Disconnect-PnPOnline", color: "#B4009E", short: "PnP", docs: "https://pnp.github.io/powershell/" },
  "AzureAD (Graph)": { install: "Install-Module -Name Microsoft.Graph.Identity.DirectoryManagement -Force", connect: "Connect-MgGraph -Scopes 'Directory.ReadWrite.All'", disconnect: "Disconnect-MgGraph", color: "#00BCF2", short: "Entra", docs: "https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/permissions-reference" },
  "Microsoft.Graph.Intune": { install: "Install-Module -Name Microsoft.Graph.DeviceManagement -Force", connect: "Connect-MgGraph -Scopes 'DeviceManagementManagedDevices.ReadWrite.All'", disconnect: "Disconnect-MgGraph", color: "#D83B01", short: "Intune", docs: "https://learn.microsoft.com/en-us/mem/intune/developer/intune-graph-apis" },
  "MSCommerce": { install: "Install-Module -Name MSCommerce -Force", connect: "Connect-MSCommerce", disconnect: "", color: "#FFB900", short: "Commerce", docs: "https://learn.microsoft.com/en-us/microsoft-365/commerce/subscriptions/allowselfservicepurchase-powershell" },
  "ExchangeOnlineProtection": { install: "# Included in ExchangeOnlineManagement", connect: "Connect-IPPSSession -UserPrincipalName {{admin}}", disconnect: "Disconnect-ExchangeOnline", color: "#E74856", short: "EOP/SCC", docs: "https://learn.microsoft.com/en-us/powershell/exchange/connect-to-scc-powershell" }
};

const CATEGORIES = [
  "User Management","Group Management","Licensing","Exchange Online","Mail Flow & Transport",
  "SharePoint Online","Teams","Security & Compliance","Conditional Access","Device Management",
  "Reports & Auditing","Tenant Configuration"
];

const WORKFLOWS = {
  "wf-onboarding": {
    name: "üöÄ User Onboarding",
    desc: "Complete checklist for onboarding a new user to your M365 tenant.",
    steps: [
      "Create the user account with a temporary password",
      "Assign the appropriate license(s)",
      "Add user to the required security and M365 groups",
      "Set mailbox timezone and language",
      "Set calendar permissions (default visibility)",
      "Assign manager in Entra ID",
      "Add to relevant Teams",
      "Verify Conditional Access policies apply"
    ],
    commands: ["Create new user","Assign license to user","Add user to group","Add team member","Set mailbox timezone","Set calendar permissions","Set user manager","Get user sign-in activity"]
  },
  "wf-offboarding": {
    name: "üîí User Offboarding",
    desc: "Secure offboarding process ‚Äî disable, revoke, convert, and clean up.",
    steps: [
      "Disable the user's sign-in immediately",
      "Revoke all active sessions and tokens",
      "Set Out of Office auto-reply",
      "Convert mailbox to shared (to keep email access)",
      "Grant manager/delegate Full Access to shared mailbox",
      "Remove all license assignments",
      "Remove from all groups",
      "Check and remove any mail forwarding rules"
    ],
    commands: ["Disable user account","Revoke user sessions","Set Out of Office","Convert to shared mailbox","Grant Full Access","Remove license from user","Get forwarding rules","Get inbox rules (user)"]
  },
  "wf-security-audit": {
    name: "üõ°Ô∏è Security Audit",
    desc: "Quick security health check across your tenant.",
    steps: [
      "List all Global Administrators",
      "Check MFA registration status for all users",
      "Find users without MFA",
      "Review Conditional Access policies",
      "Check for risky sign-ins",
      "Review risky users",
      "Find app registrations with expiring credentials",
      "Check external sharing on SharePoint sites",
      "Review mail forwarding rules",
      "Search recent audit logs for suspicious activity"
    ],
    commands: ["Get admin role members","Get MFA registration details","Get users without MFA","Get all CA policies","Get risky sign-ins","Get risky users","Get app credentials expiring","Get external sharing status","Get forwarding rules","Search unified audit log"]
  },
  "wf-tenant-review": {
    name: "üìä Tenant Health Review",
    desc: "Monthly tenant review ‚Äî licenses, usage, configuration.",
    steps: [
      "Review license consumption and availability",
      "Check for unlicensed users",
      "Review active user counts across services",
      "Check mailbox sizes and quotas",
      "Review SharePoint storage usage",
      "Check stale/inactive devices",
      "Review self-service purchase policies",
      "Check verified domains and tenant config"
    ],
    commands: ["Get all licenses in tenant","Get unlicensed users","Get active users report","Get all mailbox sizes","Get site storage usage","Get stale devices","Disable self-service purchases","Get organization details","Get verified domains"]
  },
  "wf-license-cleanup": {
    name: "üí∞ License Cleanup",
    desc: "Find and reclaim unused licenses to reduce costs.",
    steps: [
      "Review all license SKUs and available counts",
      "Find unlicensed users who may need licenses",
      "Identify disabled users still consuming licenses",
      "Check license assignment paths (direct vs group-based)",
      "Review users with specific high-cost licenses",
      "Block self-service purchases",
      "Get user sign-in activity to find inactive licensed users",
      "Remove licenses from disabled/inactive accounts"
    ],
    commands: ["Get all licenses in tenant","Get unlicensed users","Get disabled users","Get license assignment paths","Get users with specific license","Disable self-service purchases","Get user sign-in activity","Remove license from user","Get tenant SKUs overview"]
  },
  "wf-mail-hygiene": {
    name: "üìß Mail Hygiene Review",
    desc: "Audit mail flow security ‚Äî forwarding, transport rules, and protection.",
    steps: [
      "Check for mailboxes with SMTP forwarding enabled",
      "Audit inbox rules across users for suspicious forwards",
      "Review transport rules and priorities",
      "Check DKIM signing status per domain",
      "Review anti-spam policy settings",
      "Review quarantined messages",
      "Check blocked senders list",
      "Review Safe Links and Safe Attachments policies",
      "Review anti-phishing policies"
    ],
    commands: ["Get forwarding rules","Get inbox rules (user)","Get transport rules","Get DKIM config","Get anti-spam policy","Get quarantined messages","Get blocked senders","Get Safe Links policies","Get Safe Attachments policies","Get anti-phishing policies"]
  },
  "wf-guest-audit": {
    name: "üë• Guest Access Audit",
    desc: "Review external/guest user access across your tenant.",
    steps: [
      "List all guest users in the tenant",
      "Check guest user sign-in activity (find stale guests)",
      "Review which groups guests belong to",
      "Check SharePoint external sharing settings",
      "Review sites with external sharing enabled",
      "Check OAuth consent grants from external apps",
      "Review Conditional Access policies for guests",
      "Remove stale or unauthorized guest accounts"
    ],
    commands: ["Get guest users","Get user sign-in activity","Get all groups","Get tenant sharing settings","Get external sharing status","Get consent grants (admin)","Get all CA policies","Remove guest user"]
  }
};

const COMMANDS = [
  // ‚îÄ‚îÄ USER MANAGEMENT ‚îÄ‚îÄ
  { cat: "User Management", name: "Get all users", cmd: "Get-MgUser -All", module: "Microsoft.Graph", desc: "List all users in the tenant", risk: "read", perms: "User.Read.All" , related: ["Get disabled users", "Get guest users", "Bulk export users to CSV", "Get user sign-in activity"] },
  { cat: "User Management", name: "Get specific user", cmd: 'Get-MgUser -UserId "user@{{domain}}"', module: "Microsoft.Graph", desc: "Get details for a specific user", risk: "read", perms: "User.Read.All" },
  { cat: "User Management", name: "Get user properties", cmd: 'Get-MgUser -UserId "user@{{domain}}" -Property DisplayName,Mail,AccountEnabled,UserPrincipalName', module: "Microsoft.Graph", desc: "Get specific user properties", risk: "read", perms: "User.Read.All" },
  { cat: "User Management", name: "Create new user", cmd: "$PasswordProfile = @{ Password = 'TempP@ss123!'; ForceChangePasswordNextSignIn = $true }\nNew-MgUser -DisplayName \"John Doe\" -MailNickname \"jdoe\" -UserPrincipalName \"jdoe@{{domain}}\" -PasswordProfile $PasswordProfile -AccountEnabled", module: "Microsoft.Graph", desc: "Create a new user with temporary password", risk: "modify", perms: "User.ReadWrite.All" , related: ["Assign license to user", "Add member to group", "Set user manager"], csv: "DisplayName,MailNickname,UserPrincipalName,Password,Department,JobTitle,OfficeLocation" },
  { cat: "User Management", name: "Delete user", cmd: 'Remove-MgUser -UserId "user@{{domain}}" -Confirm:$false', module: "Microsoft.Graph", desc: "Delete a user (soft delete to recycle bin)", risk: "destructive", perms: "User.ReadWrite.All" , related: ["Disable user account", "Revoke user sessions", "Remove license from user", "Get deleted users"], csv: "UserPrincipalName" },
  { cat: "User Management", name: "Disable user account", cmd: 'Update-MgUser -UserId "user@{{domain}}" -AccountEnabled:$false', module: "Microsoft.Graph", desc: "Disable a user's sign-in", risk: "modify", perms: "User.ReadWrite.All" , related: ["Revoke user sessions", "Set Out of Office", "Convert to shared mailbox", "Remove license from user", "Get forwarding rules"], csv: "UserPrincipalName" },
  { cat: "User Management", name: "Enable user account", cmd: 'Update-MgUser -UserId "user@{{domain}}" -AccountEnabled:$true', module: "Microsoft.Graph", desc: "Re-enable a user's sign-in", risk: "modify", perms: "User.ReadWrite.All" , related: ["Reset user password", "Assign license to user"], csv: "UserPrincipalName" },
  { cat: "User Management", name: "Reset user password", cmd: "$params = @{ PasswordProfile = @{ Password = \"NewP@ss123!\"; ForceChangePasswordNextSignIn = $true } }\nUpdate-MgUser -UserId \"user@{{domain}}\" -BodyParameter $params", module: "Microsoft.Graph", desc: "Reset a user's password", risk: "modify", perms: "UserAuthenticationMethod.ReadWrite.All" , related: ["Revoke user sessions", "Get user auth methods"], csv: "UserPrincipalName,NewPassword" },
  { cat: "User Management", name: "Update user properties", cmd: 'Update-MgUser -UserId "user@{{domain}}" -JobTitle "IT Administrator" -Department "IT" -OfficeLocation "Stockholm"', module: "Microsoft.Graph", desc: "Update job title, department, office", risk: "modify", perms: "User.ReadWrite.All" , csv: "UserPrincipalName,JobTitle,Department,OfficeLocation" },
  { cat: "User Management", name: "Get disabled users", cmd: 'Get-MgUser -All -Filter "AccountEnabled eq false" | Select DisplayName,UserPrincipalName', module: "Microsoft.Graph", desc: "List all disabled user accounts", risk: "read", perms: "User.Read.All" , related: ["Get user sign-in activity", "Remove license from user", "Delete user"] },
  { cat: "User Management", name: "Get guest users", cmd: "Get-MgUser -All -Filter \"UserType eq 'Guest'\" | Select DisplayName,Mail,CreatedDateTime", module: "Microsoft.Graph", desc: "List all external/guest users", risk: "read", perms: "User.Read.All" , related: ["Remove guest user", "Get user sign-in activity"] },
  { cat: "User Management", name: "Remove guest user", cmd: 'Remove-MgUser -UserId "guest-object-id" -Confirm:$false', module: "Microsoft.Graph", desc: "Remove a guest user from the tenant", risk: "destructive", perms: "User.ReadWrite.All" },
  { cat: "User Management", name: "Get users without MFA", cmd: "Get-MgUser -All | ForEach-Object { $methods = Get-MgUserAuthenticationMethod -UserId $_.Id; if($methods.Count -le 1){ $_ } } | Select DisplayName,UserPrincipalName", module: "Microsoft.Graph", desc: "Find users with only password auth (no MFA)", risk: "read", perms: "UserAuthenticationMethod.Read.All" },
  { cat: "User Management", name: "Get user sign-in activity", cmd: 'Get-MgUser -All -Property DisplayName,SignInActivity | Select DisplayName,@{N="LastSignIn";E={$_.SignInActivity.LastSignInDateTime}} | Sort LastSignIn', module: "Microsoft.Graph", desc: "Get last sign-in date for all users", risk: "read", perms: "AuditLog.Read.All, User.Read.All" },
  { cat: "User Management", name: "Get user manager", cmd: 'Get-MgUserManager -UserId "user@{{domain}}" | Select -ExpandProperty AdditionalProperties', module: "Microsoft.Graph", desc: "Get a user's manager", risk: "read", perms: "User.Read.All" },
  { cat: "User Management", name: "Set user manager", cmd: "$mgr = @{ \"@odata.id\" = \"https://graph.microsoft.com/v1.0/users/{manager-id}\" }\nSet-MgUserManagerByRef -UserId \"user@{{domain}}\" -BodyParameter $mgr", module: "Microsoft.Graph", desc: "Assign a manager to a user", risk: "modify", perms: "User.ReadWrite.All" , csv: "UserPrincipalName,ManagerUPN" },
  { cat: "User Management", name: "Bulk export users to CSV", cmd: 'Get-MgUser -All -Property DisplayName,UserPrincipalName,Mail,JobTitle,Department,AccountEnabled | Export-Csv -Path "C:\\Temp\\AllUsers.csv" -NoTypeInformation', module: "Microsoft.Graph", desc: "Export all users to CSV", risk: "read", perms: "User.Read.All" },
  { cat: "User Management", name: "Revoke user sessions", cmd: 'Invoke-MgInvalidateUserRefreshToken -UserId "user@{{domain}}"', module: "Microsoft.Graph", desc: "Revoke all refresh tokens / force re-auth", risk: "modify", perms: "User.ReadWrite.All" , related: ["Disable user account", "Reset user password"] },
  { cat: "User Management", name: "Get user auth methods", cmd: 'Get-MgUserAuthenticationMethod -UserId "user@{{domain}}" | Select Id,@{N="Type";E={$_.AdditionalProperties."@odata.type"}}', module: "Microsoft.Graph", desc: "List registered authentication methods", risk: "read", perms: "UserAuthenticationMethod.Read.All" },
  { cat: "User Management", name: "Get deleted users", cmd: 'Get-MgDirectoryDeletedItemAsUser | Select DisplayName,UserPrincipalName,DeletedDateTime', module: "Microsoft.Graph", desc: "List soft-deleted users (recycle bin)", risk: "read", perms: "Directory.Read.All" },
  { cat: "User Management", name: "Restore deleted user", cmd: 'Restore-MgDirectoryDeletedItem -DirectoryObjectId "object-id"', module: "Microsoft.Graph", desc: "Restore a user from the recycle bin", risk: "modify", perms: "User.ReadWrite.All" },

  // ‚îÄ‚îÄ GROUP MANAGEMENT (14) ‚îÄ‚îÄ
  { cat: "Group Management", name: "Get all groups", cmd: "Get-MgGroup -All | Select DisplayName,GroupTypes,MailEnabled,SecurityEnabled", module: "Microsoft.Graph", desc: "List all groups in the tenant" , risk: "read", perms: "Group.Read.All" , related: ["Get group members", "Get group owners", "Create security group"] },
  { cat: "Group Management", name: "Get M365 groups", cmd: "Get-MgGroup -All -Filter \"groupTypes/any(g:g eq 'Unified')\"", module: "Microsoft.Graph", desc: "List only Microsoft 365 groups" , risk: "read", perms: "Group.Read.All" },
  { cat: "Group Management", name: "Get security groups", cmd: 'Get-MgGroup -All -Filter "securityEnabled eq true and mailEnabled eq false"', module: "Microsoft.Graph", desc: "List security groups (non-mail-enabled)" , risk: "read", perms: "Group.Read.All" },
  { cat: "Group Management", name: "Get distribution lists", cmd: "Get-DistributionGroup -ResultSize Unlimited | Select DisplayName,PrimarySmtpAddress,ManagedBy", module: "ExchangeOnlineManagement", desc: "List all distribution groups" , risk: "read" },
  { cat: "Group Management", name: "Get group members", cmd: "Get-MgGroupMember -GroupId (Get-MgGroup -Filter \"DisplayName eq 'GroupName'\").Id -All | Select @{N='Name';E={$_.AdditionalProperties.displayName}}", module: "Microsoft.Graph", desc: "List members of a specific group" , risk: "read", perms: "Group.Read.All" , related: ["Add member to group", "Remove member from group"] },
  { cat: "Group Management", name: "Get group member count", cmd: "Get-MgGroup -All -Property DisplayName,Id | ForEach { $cnt=(Get-MgGroupMember -GroupId $_.Id -All).Count; [pscustomobject]@{Group=$_.DisplayName;Members=$cnt} } | Sort Members -Desc", module: "Microsoft.Graph", desc: "Member count for every group" , risk: "read", perms: "Group.Read.All" },
  { cat: "Group Management", name: "Add user to group", cmd: 'New-MgGroupMember -GroupId "group-id" -DirectoryObjectId "user-id"', module: "Microsoft.Graph", desc: "Add a user to a group" , risk: "modify", perms: "Group.ReadWrite.All" },
  { cat: "Group Management", name: "Remove user from group", cmd: 'Remove-MgGroupMemberByRef -GroupId "group-id" -DirectoryObjectId "user-id"', module: "Microsoft.Graph", desc: "Remove a user from a group" , risk: "destructive", perms: "Group.ReadWrite.All" },
  { cat: "Group Management", name: "Create security group", cmd: 'New-MgGroup -DisplayName "SG-ProjectX" -MailEnabled:$false -MailNickname "sg-projectx" -SecurityEnabled', module: "Microsoft.Graph", desc: "Create a new security group" , risk: "modify", perms: "Group.ReadWrite.All" , related: ["Add member to group", "Get all groups"] },
  { cat: "Group Management", name: "Create M365 group", cmd: 'New-MgGroup -DisplayName "Team Project" -MailEnabled -MailNickname "teamproject" -SecurityEnabled:$false -GroupTypes "Unified"', module: "Microsoft.Graph", desc: "Create a new Microsoft 365 group" , risk: "modify", perms: "Group.ReadWrite.All" },
  { cat: "Group Management", name: "Get dynamic groups", cmd: "Get-MgGroup -All -Filter \"groupTypes/any(g:g eq 'DynamicMembership')\" | Select DisplayName,MembershipRule", module: "Microsoft.Graph", desc: "List dynamic membership groups with rules" , risk: "read", perms: "Group.Read.All" },
  { cat: "Group Management", name: "Delete group", cmd: 'Remove-MgGroup -GroupId "group-id" -Confirm:$false', module: "Microsoft.Graph", desc: "Delete a group" , risk: "destructive", perms: "Group.ReadWrite.All" },
  { cat: "Group Management", name: "Get group owners", cmd: 'Get-MgGroupOwner -GroupId "group-id" -All', module: "Microsoft.Graph", desc: "List owners of a group" , risk: "read", perms: "Group.Read.All" },
  { cat: "Group Management", name: "Get groups without owners", cmd: "Get-MgGroup -All | Where { (Get-MgGroupOwner -GroupId $_.Id -All).Count -eq 0 } | Select DisplayName,Id", module: "Microsoft.Graph", desc: "Find orphaned groups with no owners" , risk: "read", perms: "Group.Read.All" },

  // ‚îÄ‚îÄ LICENSING (8) ‚îÄ‚îÄ
  { cat: "Licensing", name: "Get all licenses in tenant", cmd: "Get-MgSubscribedSku | Select SkuPartNumber,ConsumedUnits,@{N='Total';E={$_.PrepaidUnits.Enabled}},@{N='Available';E={$_.PrepaidUnits.Enabled - $_.ConsumedUnits}}", module: "Microsoft.Graph", desc: "Overview of all license SKUs with availability" , risk: "read", perms: "Organization.Read.All" , related: ["Get unlicensed users", "Get users with specific license", "Get tenant SKUs overview"] },
  { cat: "Licensing", name: "Get user licenses", cmd: 'Get-MgUserLicenseDetail -UserId "user@{{domain}}" | Select SkuPartNumber,SkuId', module: "Microsoft.Graph", desc: "Show licenses assigned to a user" , risk: "read", perms: "Organization.Read.All" },
  { cat: "Licensing", name: "Assign license to user", cmd: 'Set-MgUserLicense -UserId "user@{{domain}}" -AddLicenses @(@{SkuId="sku-id"}) -RemoveLicenses @()', module: "Microsoft.Graph", desc: "Assign a license SKU to a user" , risk: "modify", perms: "User.ReadWrite.All" , related: ["Remove license from user", "Get all licenses in tenant", "Get users with specific license"], csv: "UserPrincipalName,SkuId" },
  { cat: "Licensing", name: "Remove license from user", cmd: 'Set-MgUserLicense -UserId "user@{{domain}}" -AddLicenses @() -RemoveLicenses @("sku-id")', module: "Microsoft.Graph", desc: "Remove a license from a user" , risk: "destructive", perms: "User.ReadWrite.All" , related: ["Get all licenses in tenant", "Disable user account"], csv: "UserPrincipalName,SkuId" },
  { cat: "Licensing", name: "Get unlicensed users", cmd: "Get-MgUser -All -Filter \"assignedLicenses/\\$count eq 0\" -ConsistencyLevel eventual -CountVariable c | Select DisplayName,UserPrincipalName", module: "Microsoft.Graph", desc: "Find users with no licenses assigned" , risk: "read", perms: "User.ReadWrite.All" , related: ["Assign license to user", "Get all licenses in tenant"] },
  { cat: "Licensing", name: "Get users with specific license", cmd: "Get-MgUser -All -Filter \"assignedLicenses/any(l:l/skuId eq 'sku-id')\" | Select DisplayName,UserPrincipalName", module: "Microsoft.Graph", desc: "Find all users with a specific SKU" , risk: "read", perms: "User.ReadWrite.All" },
  { cat: "Licensing", name: "Disable self-service purchases", cmd: "Get-MSCommerceProductPolicies -PolicyId AllowSelfServicePurchase | ForEach { Update-MSCommerceProductPolicy -PolicyId AllowSelfServicePurchase -ProductId $_.ProductId -Value \"Disabled\" }", module: "MSCommerce", desc: "Block users from self-service license purchases" , risk: "read" },
  { cat: "Licensing", name: "Get license assignment paths", cmd: "Get-MgUser -All -Property DisplayName,LicenseAssignmentStates | Select DisplayName,@{N='Assignments';E={$_.LicenseAssignmentStates | Select AssignedByGroup,SkuId}}", module: "Microsoft.Graph", desc: "Check if licenses are direct or group-based" , risk: "read", perms: "User.ReadWrite.All" },

  // ‚îÄ‚îÄ EXCHANGE ONLINE (22) ‚îÄ‚îÄ
  { cat: "Exchange Online", name: "Get all mailboxes", cmd: "Get-EXOMailbox -ResultSize Unlimited | Select DisplayName,PrimarySmtpAddress,RecipientTypeDetails", module: "ExchangeOnlineManagement", desc: "List all mailboxes" , risk: "read" , related: ["Get all mailbox sizes", "Get mailbox permissions"] },
  { cat: "Exchange Online", name: "Get shared mailboxes", cmd: "Get-EXOMailbox -RecipientTypeDetails SharedMailbox -ResultSize Unlimited | Select DisplayName,PrimarySmtpAddress", module: "ExchangeOnlineManagement", desc: "List only shared mailboxes" , risk: "read" },
  { cat: "Exchange Online", name: "Create shared mailbox", cmd: 'New-Mailbox -Shared -Name "Info" -DisplayName "Info Mailbox" -PrimarySmtpAddress info@{{domain}}', module: "ExchangeOnlineManagement", desc: "Create a new shared mailbox" , risk: "modify" },
  { cat: "Exchange Online", name: "Get mailbox permissions", cmd: 'Get-MailboxPermission -Identity "shared@{{domain}}" | Where { $_.User -ne "NT AUTHORITY\\SELF" }', module: "ExchangeOnlineManagement", desc: "See who has access to a mailbox" , risk: "read" , related: ["Grant full access to mailbox", "Grant send-as permission"] },
  { cat: "Exchange Online", name: "Grant Full Access", cmd: 'Add-MailboxPermission -Identity "shared@{{domain}}" -User "user@{{domain}}" -AccessRights FullAccess -AutoMapping $true', module: "ExchangeOnlineManagement", desc: "Give full access to a mailbox" , risk: "modify" },
  { cat: "Exchange Online", name: "Remove Full Access", cmd: 'Remove-MailboxPermission -Identity "shared@{{domain}}" -User "user@{{domain}}" -AccessRights FullAccess -Confirm:$false', module: "ExchangeOnlineManagement", desc: "Remove full access from a mailbox" , risk: "destructive" },
  { cat: "Exchange Online", name: "Grant Send As", cmd: 'Add-RecipientPermission -Identity "shared@{{domain}}" -Trustee "user@{{domain}}" -AccessRights SendAs -Confirm:$false', module: "ExchangeOnlineManagement", desc: "Give Send As permission" , risk: "modify" },
  { cat: "Exchange Online", name: "Grant Send on Behalf", cmd: 'Set-Mailbox -Identity "shared@{{domain}}" -GrantSendOnBehalfTo "user@{{domain}}"', module: "ExchangeOnlineManagement", desc: "Give Send on Behalf permission" , risk: "modify" },
  { cat: "Exchange Online", name: "Get mailbox size", cmd: 'Get-EXOMailboxStatistics -Identity "user@{{domain}}" | Select DisplayName,TotalItemSize,ItemCount', module: "ExchangeOnlineManagement", desc: "Check mailbox size and item count" , risk: "read" },
  { cat: "Exchange Online", name: "Get all mailbox sizes", cmd: "Get-EXOMailbox -ResultSize Unlimited | Get-EXOMailboxStatistics | Select DisplayName,TotalItemSize,ItemCount | Sort TotalItemSize -Descending", module: "ExchangeOnlineManagement", desc: "All mailboxes sorted by size" , risk: "read" },
  { cat: "Exchange Online", name: "Set mailbox timezone", cmd: 'Set-MailboxRegionalConfiguration -Identity "user@{{domain}}" -TimeZone "W. Europe Standard Time" -Language sv-SE -LocalizeDefaultFolderName', module: "ExchangeOnlineManagement", desc: "Set timezone and language on mailbox" , risk: "modify" },
  { cat: "Exchange Online", name: "Bulk set timezone", cmd: "Get-EXOMailbox -ResultSize Unlimited | ForEach { Set-MailboxRegionalConfiguration -Identity $_.PrimarySmtpAddress -TimeZone \"W. Europe Standard Time\" -Language sv-SE }", module: "ExchangeOnlineManagement", desc: "Set timezone for all mailboxes" , risk: "read" },
  { cat: "Exchange Online", name: "Get forwarding rules", cmd: "Get-EXOMailbox -ResultSize Unlimited | Where { $_.ForwardingSmtpAddress -ne $null } | Select DisplayName,ForwardingSmtpAddress,DeliverToMailboxAndForward", module: "ExchangeOnlineManagement", desc: "Find mailboxes with forwarding enabled" , risk: "read" , related: ["Get inbox rules (user)", "Get transport rules"] },
  { cat: "Exchange Online", name: "Remove forwarding", cmd: 'Set-Mailbox -Identity "user@{{domain}}" -ForwardingSmtpAddress $null -DeliverToMailboxAndForward $false', module: "ExchangeOnlineManagement", desc: "Remove SMTP forwarding from a mailbox" , risk: "destructive" },
  { cat: "Exchange Online", name: "Get inbox rules (user)", cmd: 'Get-InboxRule -Mailbox "user@{{domain}}" | Select Name,Description,Enabled', module: "ExchangeOnlineManagement", desc: "List inbox rules for a user" , risk: "read" },
  { cat: "Exchange Online", name: "Convert to shared mailbox", cmd: 'Set-Mailbox -Identity "user@{{domain}}" -Type Shared', module: "ExchangeOnlineManagement", desc: "Convert user mailbox to shared" , risk: "modify" , related: ["Remove license from user", "Grant full access to mailbox", "Set Out of Office"] },
  { cat: "Exchange Online", name: "Set Out of Office", cmd: 'Set-MailboxAutoReplyConfiguration -Identity "user@{{domain}}" -AutoReplyState Enabled -InternalMessage "I am currently out of office." -ExternalMessage "I am currently out of office."', module: "ExchangeOnlineManagement", desc: "Enable auto-reply / out of office" , risk: "modify" , related: ["Disable user account", "Convert to shared mailbox", "Get forwarding rules"] },
  { cat: "Exchange Online", name: "Disable Out of Office", cmd: 'Set-MailboxAutoReplyConfiguration -Identity "user@{{domain}}" -AutoReplyState Disabled', module: "ExchangeOnlineManagement", desc: "Turn off auto-reply" , risk: "modify" },
  { cat: "Exchange Online", name: "Get calendar permissions", cmd: 'Get-MailboxFolderPermission -Identity "user@{{domain}}:\\Calendar"', module: "ExchangeOnlineManagement", desc: "Check calendar sharing permissions" , risk: "read" },
  { cat: "Exchange Online", name: "Set calendar permissions", cmd: 'Set-MailboxFolderPermission -Identity "user@{{domain}}:\\Calendar" -User Default -AccessRights Reviewer', module: "ExchangeOnlineManagement", desc: "Set default calendar visibility" , risk: "modify" },
  { cat: "Exchange Online", name: "Get resource mailboxes", cmd: "Get-EXOMailbox -RecipientTypeDetails RoomMailbox,EquipmentMailbox | Select DisplayName,RecipientTypeDetails,PrimarySmtpAddress", module: "ExchangeOnlineManagement", desc: "List room and equipment mailboxes" , risk: "read" },
  { cat: "Exchange Online", name: "Get mail contacts", cmd: "Get-MailContact -ResultSize Unlimited | Select DisplayName,ExternalEmailAddress", module: "ExchangeOnlineManagement", desc: "List external mail contacts" , risk: "read" },
  { cat: "Exchange Online", name: "Set mailbox litigation hold", cmd: 'Set-Mailbox -Identity "user@{{domain}}" -LitigationHoldEnabled $true -LitigationHoldDuration 365', module: "ExchangeOnlineManagement", desc: "Enable litigation hold (365 days)" , risk: "modify" },
  { cat: "Exchange Online", name: "Get mailbox hold status", cmd: 'Get-Mailbox -Identity "user@{{domain}}" | Select DisplayName,LitigationHoldEnabled,InPlaceHolds', module: "ExchangeOnlineManagement", desc: "Check if mailbox is on hold" , risk: "read" },

  // ‚îÄ‚îÄ MAIL FLOW & TRANSPORT (10) ‚îÄ‚îÄ
  { cat: "Mail Flow & Transport", name: "Get transport rules", cmd: "Get-TransportRule | Select Name,State,Priority", module: "ExchangeOnlineManagement", desc: "List all mail flow rules" , risk: "read" },
  { cat: "Mail Flow & Transport", name: "Get accepted domains", cmd: "Get-AcceptedDomain | Select DomainName,DomainType,Default", module: "ExchangeOnlineManagement", desc: "List verified domains in Exchange" , risk: "read" },
  { cat: "Mail Flow & Transport", name: "Get connectors", cmd: "Get-InboundConnector | Select Name,Enabled; Get-OutboundConnector | Select Name,Enabled", module: "ExchangeOnlineManagement", desc: "List inbound and outbound connectors" , risk: "read" },
  { cat: "Mail Flow & Transport", name: "Message trace", cmd: 'Get-MessageTrace -SenderAddress "user@{{domain}}" -StartDate (Get-Date).AddDays(-7) -EndDate (Get-Date) | Select Received,SenderAddress,RecipientAddress,Subject,Status', module: "ExchangeOnlineManagement", desc: "Trace messages from a sender (last 7 days)" , risk: "read" },
  { cat: "Mail Flow & Transport", name: "Message trace by recipient", cmd: 'Get-MessageTrace -RecipientAddress "user@{{domain}}" -StartDate (Get-Date).AddDays(-7) -EndDate (Get-Date) | Select Received,SenderAddress,Subject,Status', module: "ExchangeOnlineManagement", desc: "Trace messages TO a recipient" , risk: "read" },
  { cat: "Mail Flow & Transport", name: "Get quarantined messages", cmd: "Get-QuarantineMessage -StartReceivedDate (Get-Date).AddDays(-7) | Select Subject,SenderAddress,RecipientAddress,Type", module: "ExchangeOnlineManagement", desc: "View quarantined emails" , risk: "read" },
  { cat: "Mail Flow & Transport", name: "Release quarantined message", cmd: 'Release-QuarantineMessage -Identity "quarantine-id" -ReleaseToAll', module: "ExchangeOnlineManagement", desc: "Release a message from quarantine" , risk: "modify" },
  { cat: "Mail Flow & Transport", name: "Get anti-spam policy", cmd: "Get-HostedContentFilterPolicy | Select Name,BulkThreshold,SpamAction,HighConfidenceSpamAction", module: "ExchangeOnlineManagement", desc: "View spam filter settings" , risk: "read" },
  { cat: "Mail Flow & Transport", name: "Get DKIM config", cmd: "Get-DkimSigningConfig | Select Domain,Enabled,Status", module: "ExchangeOnlineManagement", desc: "Check DKIM signing status per domain" , risk: "read" },
  { cat: "Mail Flow & Transport", name: "Get blocked senders", cmd: "Get-HostedContentFilterPolicy | Select -ExpandProperty BlockedSenders", module: "ExchangeOnlineManagement", desc: "List globally blocked senders" , risk: "read" },

  // ‚îÄ‚îÄ SHAREPOINT ONLINE (14) ‚îÄ‚îÄ
  { cat: "SharePoint Online", name: "Get all site collections", cmd: "Get-SPOSite -Limit All | Select Title,Url,StorageUsageCurrent", module: "Microsoft.Online.SharePoint.PowerShell", desc: "List all SharePoint site collections" , risk: "read" },
  { cat: "SharePoint Online", name: "Get site details", cmd: 'Get-SPOSite -Identity "https://{{domain}}.sharepoint.com/sites/sitename" -Detailed', module: "Microsoft.Online.SharePoint.PowerShell", desc: "Detailed info about a site" , risk: "read" },
  { cat: "SharePoint Online", name: "Get site storage usage", cmd: "Get-SPOSite -Limit All | Select Title,Url,@{N='StorageGB';E={[math]::Round($_.StorageUsageCurrent/1024,2)}} | Sort StorageGB -Descending", module: "Microsoft.Online.SharePoint.PowerShell", desc: "Storage usage per site in GB, sorted" , risk: "read" },
  { cat: "SharePoint Online", name: "Set site storage quota", cmd: 'Set-SPOSite -Identity "https://{{domain}}.sharepoint.com/sites/sitename" -StorageQuota 5120', module: "Microsoft.Online.SharePoint.PowerShell", desc: "Set storage quota (MB) on a site" , risk: "modify" },
  { cat: "SharePoint Online", name: "Add site collection admin", cmd: 'Set-SPOUser -Site "https://{{domain}}.sharepoint.com/sites/sitename" -LoginName "user@{{domain}}" -IsSiteCollectionAdmin $true', module: "Microsoft.Online.SharePoint.PowerShell", desc: "Make someone a site collection admin" , risk: "modify" },
  { cat: "SharePoint Online", name: "Get external sharing status", cmd: "Get-SPOSite -Limit All | Select Title,Url,SharingCapability | Where { $_.SharingCapability -ne 'Disabled' }", module: "Microsoft.Online.SharePoint.PowerShell", desc: "Sites with external sharing enabled" , risk: "read" },
  { cat: "SharePoint Online", name: "Disable external sharing on site", cmd: 'Set-SPOSite -Identity "https://{{domain}}.sharepoint.com/sites/sitename" -SharingCapability Disabled', module: "Microsoft.Online.SharePoint.PowerShell", desc: "Block external sharing on a site" , risk: "modify" },
  { cat: "SharePoint Online", name: "Get OneDrive URLs", cmd: "Get-SPOSite -IncludePersonalSite $true -Limit All -Filter \"Url -like '-my.sharepoint.com'\" | Select Owner,Url,StorageUsageCurrent", module: "Microsoft.Online.SharePoint.PowerShell", desc: "List all OneDrive for Business sites" , risk: "read" },
  { cat: "SharePoint Online", name: "Get deleted sites", cmd: "Get-SPODeletedSite | Select Url,DeletionTime", module: "Microsoft.Online.SharePoint.PowerShell", desc: "List sites in the recycle bin" , risk: "destructive" },
  { cat: "SharePoint Online", name: "Restore deleted site", cmd: 'Restore-SPODeletedSite -Identity "https://{{domain}}.sharepoint.com/sites/sitename"', module: "Microsoft.Online.SharePoint.PowerShell", desc: "Restore a site from recycle bin" , risk: "destructive" },
  { cat: "SharePoint Online", name: "Get SharePoint lists (PnP)", cmd: "Get-PnPList | Select Title,ItemCount,BaseTemplate", module: "PnP.PowerShell", desc: "List all lists/libraries on connected site" , risk: "read" },
  { cat: "SharePoint Online", name: "Export list items (PnP)", cmd: 'Get-PnPListItem -List "Documents" -PageSize 500 | Select -ExpandProperty FieldValues | Export-Csv "items.csv" -NoTypeInformation', module: "PnP.PowerShell", desc: "Export list/library items to CSV" , risk: "read" },
  { cat: "SharePoint Online", name: "Get tenant sharing settings", cmd: "Get-SPOTenant | Select SharingCapability,DefaultSharingLinkType,PreventExternalUsersFromResharing", module: "Microsoft.Online.SharePoint.PowerShell", desc: "View tenant-level sharing config" , risk: "read" },
  { cat: "SharePoint Online", name: "Lock a site (read only)", cmd: 'Set-SPOSite -Identity "https://{{domain}}.sharepoint.com/sites/sitename" -LockState ReadOnly', module: "Microsoft.Online.SharePoint.PowerShell", desc: "Set a site to read-only mode" , risk: "modify" },

  // ‚îÄ‚îÄ TEAMS (11) ‚îÄ‚îÄ
  { cat: "Teams", name: "Get all teams", cmd: "Get-Team | Select DisplayName,GroupId,Visibility,Archived", module: "MicrosoftTeams", desc: "List all Teams" , risk: "read" , related: ["Get team members", "Get team channels"] },
  { cat: "Teams", name: "Get team members", cmd: 'Get-TeamUser -GroupId "group-id" | Select Name,User,Role', module: "MicrosoftTeams", desc: "List members and their roles" , risk: "read" },
  { cat: "Teams", name: "Add team member", cmd: 'Add-TeamUser -GroupId "group-id" -User "user@{{domain}}" -Role Member', module: "MicrosoftTeams", desc: "Add a user to a team" , risk: "modify" },
  { cat: "Teams", name: "Remove team member", cmd: 'Remove-TeamUser -GroupId "group-id" -User "user@{{domain}}"', module: "MicrosoftTeams", desc: "Remove a user from a team" , risk: "destructive" },
  { cat: "Teams", name: "Create new team", cmd: 'New-Team -DisplayName "Project Alpha" -Description "Project team" -Visibility Private', module: "MicrosoftTeams", desc: "Create a new team" , risk: "modify" },
  { cat: "Teams", name: "Get team channels", cmd: 'Get-TeamChannel -GroupId "group-id" | Select DisplayName,MembershipType', module: "MicrosoftTeams", desc: "List channels in a team" , risk: "read" },
  { cat: "Teams", name: "Create team channel", cmd: 'New-TeamChannel -GroupId "group-id" -DisplayName "Design" -MembershipType Standard', module: "MicrosoftTeams", desc: "Add a channel to a team" , risk: "modify" },
  { cat: "Teams", name: "Remove team channel", cmd: 'Remove-TeamChannel -GroupId "group-id" -DisplayName "Old Channel"', module: "MicrosoftTeams", desc: "Delete a channel from a team" , risk: "destructive" },
  { cat: "Teams", name: "Get Teams policies", cmd: "Get-CsTeamsMeetingPolicy | Select Identity,AllowTranscription,AllowRecording,AllowIPVideo", module: "MicrosoftTeams", desc: "View Teams meeting policies" , risk: "read" },
  { cat: "Teams", name: "Archive a team", cmd: 'Set-TeamArchivedState -GroupId "group-id" -Archived $true', module: "MicrosoftTeams", desc: "Archive a team (read-only)" , risk: "modify" },
  { cat: "Teams", name: "Get Teams apps", cmd: "Get-TeamsApp | Select DisplayName,DistributionMethod,ExternalId", module: "MicrosoftTeams", desc: "List installed Teams apps" , risk: "read" },

  // ‚îÄ‚îÄ SECURITY & COMPLIANCE (15) ‚îÄ‚îÄ
  { cat: "Security & Compliance", name: "Get admin role members", cmd: "Get-MgDirectoryRoleMember -DirectoryRoleId (Get-MgDirectoryRole -Filter \"DisplayName eq 'Global Administrator'\").Id | Select @{N='Name';E={$_.AdditionalProperties.displayName}}", module: "Microsoft.Graph", desc: "List all Global Admins" , risk: "read", perms: "RoleManagement.Read.Directory" },
  { cat: "Security & Compliance", name: "Get all directory roles", cmd: "Get-MgDirectoryRole | Select DisplayName,Id", module: "Microsoft.Graph", desc: "List all activated admin roles" , risk: "read", perms: "RoleManagement.Read.Directory" },
  { cat: "Security & Compliance", name: "Get role assignments for user", cmd: "Get-MgUserMemberOf -UserId \"user@{{domain}}\" | Where { $_.AdditionalProperties.\"@odata.type\" -eq \"#microsoft.graph.directoryRole\" } | Select @{N='Role';E={$_.AdditionalProperties.displayName}}", module: "Microsoft.Graph", desc: "Check what admin roles a user has" , risk: "read", perms: "RoleManagement.Read.Directory" },
  { cat: "Security & Compliance", name: "Get MFA registration details", cmd: "Get-MgReportAuthenticationMethodUserRegistrationDetail | Select UserPrincipalName,IsMfaRegistered,MethodsRegistered | Sort IsMfaRegistered", module: "Microsoft.Graph", desc: "MFA registration status per user" , risk: "read", perms: "UserAuthenticationMethod.Read.All" },
  { cat: "Security & Compliance", name: "Get risky users", cmd: "Get-MgRiskyUser -Filter \"RiskLevel eq 'high'\" | Select UserDisplayName,RiskLevel,RiskState,RiskLastUpdatedDateTime", module: "Microsoft.Graph", desc: "List high-risk users (Identity Protection)" , risk: "read", perms: "IdentityRiskyUser.Read.All" , related: ["Get risky sign-ins", "Get user sign-in activity", "Revoke user sessions"] },
  { cat: "Security & Compliance", name: "Get risky sign-ins", cmd: "Get-MgRiskySignIn -Top 50 | Select UserDisplayName,RiskLevel,RiskDetail,IPAddress,CreatedDateTime", module: "Microsoft.Graph", desc: "Recent risky sign-in events" , risk: "read", perms: "IdentityRiskyUser.Read.All" , related: ["Get risky users", "Get sign-in logs"] },
  { cat: "Security & Compliance", name: "Get sign-in logs", cmd: "Get-MgAuditLogSignIn -Top 100 | Select UserDisplayName,AppDisplayName,Status,ConditionalAccessStatus,IPAddress", module: "Microsoft.Graph", desc: "Recent sign-in audit logs" , risk: "read", perms: "AuditLog.Read.All" },
  { cat: "Security & Compliance", name: "Get audit logs", cmd: "Get-MgAuditLogDirectoryAudit -Top 50 | Select ActivityDisplayName,InitiatedBy,TargetResources,ActivityDateTime", module: "Microsoft.Graph", desc: "Recent directory audit events" , risk: "read", perms: "AuditLog.Read.All" , related: ["Get sign-in logs", "Get mailbox audit logs"] },
  { cat: "Security & Compliance", name: "Get app registrations", cmd: "Get-MgApplication -All | Select DisplayName,AppId,CreatedDateTime,SignInAudience", module: "Microsoft.Graph", desc: "List all app registrations" , risk: "read", perms: "Application.Read.All" },
  { cat: "Security & Compliance", name: "Get enterprise apps", cmd: "Get-MgServicePrincipal -All | Select DisplayName,AppId,AccountEnabled,ServicePrincipalType", module: "Microsoft.Graph", desc: "List enterprise applications" , risk: "read", perms: "Application.Read.All" },
  { cat: "Security & Compliance", name: "Get app credentials expiring", cmd: "Get-MgApplication -All | ForEach { $app=$_; $_.PasswordCredentials | Where { $_.EndDateTime -lt (Get-Date).AddDays(30) } | Select @{N='App';E={$app.DisplayName}},EndDateTime,DisplayName }", module: "Microsoft.Graph", desc: "Find app secrets expiring within 30 days" , risk: "read", perms: "Application.Read.All" },
  { cat: "Security & Compliance", name: "Search unified audit log", cmd: "Search-UnifiedAuditLog -StartDate (Get-Date).AddDays(-7) -EndDate (Get-Date) -RecordType AzureActiveDirectory -ResultSize 100 | Select CreationDate,UserIds,Operations", module: "ExchangeOnlineManagement", desc: "Search audit log for Entra ID events" , risk: "read" },
  { cat: "Security & Compliance", name: "Get DLP policies", cmd: "Get-DlpCompliancePolicy | Select Name,Mode,Enabled", module: "ExchangeOnlineProtection", desc: "List Data Loss Prevention policies" , risk: "read" },
  { cat: "Security & Compliance", name: "Get retention policies", cmd: "Get-RetentionCompliancePolicy | Select Name,Enabled,Mode", module: "ExchangeOnlineProtection", desc: "List retention policies" , risk: "read" },
  { cat: "Security & Compliance", name: "Get sensitivity labels", cmd: "Get-Label | Select DisplayName,Guid,ContentType,Enabled", module: "ExchangeOnlineProtection", desc: "List sensitivity / information protection labels" , risk: "read" },

  // ‚îÄ‚îÄ CONDITIONAL ACCESS (7) ‚îÄ‚îÄ
  { cat: "Conditional Access", name: "Get all CA policies", cmd: "Get-MgIdentityConditionalAccessPolicy | Select DisplayName,State,CreatedDateTime,ModifiedDateTime", module: "Microsoft.Graph", desc: "List all Conditional Access policies" , risk: "read", perms: "Policy.Read.All" , related: ["Enable CA policy", "Disable CA policy", "Export all CA policies to JSON"] },
  { cat: "Conditional Access", name: "Get CA policy details", cmd: 'Get-MgIdentityConditionalAccessPolicy -ConditionalAccessPolicyId "policy-id" | ConvertTo-Json -Depth 10', module: "Microsoft.Graph", desc: "Full JSON details of a specific CA policy" , risk: "read", perms: "Policy.Read.All" },
  { cat: "Conditional Access", name: "Get enabled CA policies", cmd: "Get-MgIdentityConditionalAccessPolicy -Filter \"State eq 'enabled'\" | Select DisplayName,State", module: "Microsoft.Graph", desc: "List only active CA policies" , risk: "read", perms: "Policy.Read.All" },
  { cat: "Conditional Access", name: "Get report-only CA policies", cmd: "Get-MgIdentityConditionalAccessPolicy -Filter \"State eq 'enabledForReportingButNotEnforced'\" | Select DisplayName", module: "Microsoft.Graph", desc: "List policies in report-only mode" , risk: "read", perms: "Policy.Read.All" },
  { cat: "Conditional Access", name: "Get disabled CA policies", cmd: "Get-MgIdentityConditionalAccessPolicy -Filter \"State eq 'disabled'\" | Select DisplayName", module: "Microsoft.Graph", desc: "List disabled CA policies" , risk: "read", perms: "Policy.Read.All" },
  { cat: "Conditional Access", name: "Get named locations", cmd: "Get-MgIdentityConditionalAccessNamedLocation | Select DisplayName,@{N='Type';E={$_.AdditionalProperties.'@odata.type'}}", module: "Microsoft.Graph", desc: "List trusted/named network locations" , risk: "read", perms: "Policy.Read.All" },
  { cat: "Conditional Access", name: "Export all CA policies", cmd: "Get-MgIdentityConditionalAccessPolicy | ConvertTo-Json -Depth 10 | Out-File 'CA-Policies-Backup.json'", module: "Microsoft.Graph", desc: "Backup/export all CA policies to JSON" , risk: "read", perms: "Policy.Read.All" },

  // ‚îÄ‚îÄ DEVICE MANAGEMENT (11) ‚îÄ‚îÄ
  { cat: "Device Management", name: "Get all managed devices", cmd: "Get-MgDeviceManagementManagedDevice -All | Select DeviceName,OperatingSystem,ComplianceState,LastSyncDateTime", module: "Microsoft.Graph.Intune", desc: "List all Intune-managed devices" , risk: "read", perms: "DeviceManagementManagedDevices.Read.All" , related: ["Get non-compliant devices", "Get stale devices", "Wipe device"] },
  { cat: "Device Management", name: "Get non-compliant devices", cmd: "Get-MgDeviceManagementManagedDevice -Filter \"complianceState eq 'noncompliant'\" | Select DeviceName,UserDisplayName,ComplianceState", module: "Microsoft.Graph.Intune", desc: "Find devices that fail compliance" , risk: "read", perms: "DeviceManagementManagedDevices.Read.All" , related: ["Get all managed devices", "Get compliance policies"] },
  { cat: "Device Management", name: "Get device compliance policies", cmd: "Get-MgDeviceManagementDeviceCompliancePolicy | Select DisplayName,LastModifiedDateTime", module: "Microsoft.Graph.Intune", desc: "List Intune compliance policies" , risk: "read", perms: "DeviceManagementManagedDevices.Read.All" },
  { cat: "Device Management", name: "Get device config profiles", cmd: "Get-MgDeviceManagementDeviceConfiguration | Select DisplayName,LastModifiedDateTime", module: "Microsoft.Graph.Intune", desc: "List Intune configuration profiles" , risk: "read", perms: "DeviceManagementManagedDevices.Read.All" },
  { cat: "Device Management", name: "Get Entra ID devices", cmd: "Get-MgDevice -All | Select DisplayName,OperatingSystem,TrustType,ApproximateLastSignInDateTime", module: "Microsoft.Graph", desc: "List devices registered in Entra ID" , risk: "read", perms: "Device.Read.All" },
  { cat: "Device Management", name: "Get stale devices", cmd: "Get-MgDevice -All | Where { $_.ApproximateLastSignInDateTime -lt (Get-Date).AddDays(-90) } | Select DisplayName,OperatingSystem,ApproximateLastSignInDateTime", module: "Microsoft.Graph", desc: "Devices inactive for 90+ days" , risk: "read", perms: "Device.Read.All" },
  { cat: "Device Management", name: "Delete stale device", cmd: 'Remove-MgDevice -DeviceId "device-object-id" -Confirm:$false', module: "Microsoft.Graph", desc: "Remove a stale device from Entra ID" , risk: "destructive", perms: "Device.ReadWrite.All" },
  { cat: "Device Management", name: "Remote sync device", cmd: 'Invoke-MgDeviceManagementManagedDeviceSyncDevice -ManagedDeviceId "device-id"', module: "Microsoft.Graph.Intune", desc: "Trigger a sync on a managed device" , risk: "modify", perms: "DeviceManagementManagedDevices.ReadWrite.All" },
  { cat: "Device Management", name: "Remote wipe device", cmd: 'Invoke-MgDeviceManagementManagedDeviceWipe -ManagedDeviceId "device-id"', module: "Microsoft.Graph.Intune", desc: "Factory reset a managed device" , risk: "destructive", perms: "DeviceManagementManagedDevices.ReadWrite.All" },
  { cat: "Device Management", name: "Get Autopilot devices", cmd: "Get-MgDeviceManagementWindowsAutopilotDeviceIdentity -All | Select SerialNumber,Model,GroupTag,EnrollmentState", module: "Microsoft.Graph.Intune", desc: "List Windows Autopilot devices" , risk: "read", perms: "DeviceManagementManagedDevices.Read.All" },
  { cat: "Device Management", name: "Get device categories", cmd: "Get-MgDeviceManagementDeviceCategory | Select DisplayName,Id", module: "Microsoft.Graph.Intune", desc: "List Intune device categories" , risk: "read", perms: "DeviceManagementManagedDevices.Read.All" },

  // ‚îÄ‚îÄ REPORTS & AUDITING (8) ‚îÄ‚îÄ
  { cat: "Reports & Auditing", name: "Get mailbox usage report", cmd: "Get-MgReportMailboxUsageDetail -Period 'D30' -OutFile 'MailboxUsage.csv'", module: "Microsoft.Graph", desc: "Mailbox usage over last 30 days" , risk: "read", perms: "Reports.Read.All" },
  { cat: "Reports & Auditing", name: "Get OneDrive usage report", cmd: "Get-MgReportOneDriveUsageAccountDetail -Period 'D30' -OutFile 'OneDriveUsage.csv'", module: "Microsoft.Graph", desc: "OneDrive usage per user" , risk: "read", perms: "Reports.Read.All" },
  { cat: "Reports & Auditing", name: "Get SharePoint usage report", cmd: "Get-MgReportSharePointSiteUsageDetail -Period 'D30' -OutFile 'SPOUsage.csv'", module: "Microsoft.Graph", desc: "SharePoint site usage report" , risk: "read", perms: "Reports.Read.All" },
  { cat: "Reports & Auditing", name: "Get Teams usage report", cmd: "Get-MgReportTeamUserActivityUserDetail -Period 'D30' -OutFile 'TeamsUsage.csv'", module: "Microsoft.Graph", desc: "Teams activity per user" , risk: "read", perms: "Reports.Read.All" },
  { cat: "Reports & Auditing", name: "Get active users report", cmd: "Get-MgReportOffice365ActiveUserDetail -Period 'D30' -OutFile 'ActiveUsers.csv'", module: "Microsoft.Graph", desc: "Active user counts across all services" , risk: "read", perms: "Reports.Read.All" },
  { cat: "Reports & Auditing", name: "Get email activity report", cmd: "Get-MgReportEmailActivityUserDetail -Period 'D30' -OutFile 'EmailActivity.csv'", module: "Microsoft.Graph", desc: "Email send/receive activity per user" , risk: "read", perms: "Reports.Read.All" },
  { cat: "Reports & Auditing", name: "Get M365 app usage report", cmd: "Get-MgReportOffice365ActiveUserDetail -Period 'D30' -OutFile 'AppUsage.csv'", module: "Microsoft.Graph", desc: "Which M365 apps each user is active in" , risk: "read", perms: "Reports.Read.All" },
  { cat: "Reports & Auditing", name: "Get credential user registration", cmd: "Get-MgReportCredentialUserRegistrationDetail | Select UserPrincipalName,AuthMethods,IsRegistered,IsEnabled", module: "Microsoft.Graph", desc: "SSPR and MFA registration details" , risk: "read", perms: "UserAuthenticationMethod.Read.All" },

  // ‚îÄ‚îÄ TENANT CONFIGURATION (9) ‚îÄ‚îÄ
  { cat: "Tenant Configuration", name: "Get organization details", cmd: "Get-MgOrganization | Select DisplayName,VerifiedDomains,TenantType,CountryLetterCode", module: "Microsoft.Graph", desc: "Basic tenant information" , risk: "read", perms: "Organization.Read.All" },
  { cat: "Tenant Configuration", name: "Get verified domains", cmd: "(Get-MgOrganization).VerifiedDomains | Select Name,IsDefault,IsInitial", module: "Microsoft.Graph", desc: "List all verified domains" , risk: "read", perms: "Organization.Read.All" },
  { cat: "Tenant Configuration", name: "Get auth methods policy", cmd: "Get-MgPolicyAuthenticationMethodPolicy | Select -ExpandProperty AuthenticationMethodConfigurations | Select Id,State", module: "Microsoft.Graph", desc: "View authentication methods configuration" , risk: "read", perms: "UserAuthenticationMethod.Read.All" },
  { cat: "Tenant Configuration", name: "Get SSPR settings", cmd: "Get-MgPolicyAuthorizationPolicy | Select AllowedToSignUpEmailBasedSubscriptions,AllowEmailVerifiedUsersToJoinOrganization", module: "Microsoft.Graph", desc: "Self-service password reset config" , risk: "read", perms: "Directory.Read.All" },
  { cat: "Tenant Configuration", name: "Get tenant SKUs overview", cmd: "Get-MgSubscribedSku | Select SkuPartNumber,@{N='Available';E={$_.PrepaidUnits.Enabled - $_.ConsumedUnits}},ConsumedUnits,@{N='Total';E={$_.PrepaidUnits.Enabled}}", module: "Microsoft.Graph", desc: "License availability overview" , risk: "read", perms: "Organization.Read.All" },
  { cat: "Tenant Configuration", name: "Get OAuth2 permission grants", cmd: "Get-MgOauth2PermissionGrant -All | Select ClientId,ConsentType,Scope | Group ConsentType", module: "Microsoft.Graph", desc: "OAuth consent grants grouped by type" , risk: "read", perms: "Directory.Read.All" },
  { cat: "Tenant Configuration", name: "Get SPO tenant settings", cmd: "Get-SPOTenant | Select SharingCapability,OneDriveStorageQuota,RequireAcceptingAccountMatchInvitedAccount,NotifyOwnersWhenItemsReshared", module: "Microsoft.Online.SharePoint.PowerShell", desc: "SharePoint & OneDrive tenant settings" , risk: "read" },
  { cat: "Tenant Configuration", name: "Get password expiration policy", cmd: "(Get-MgOrganization).PasswordPolicies", module: "Microsoft.Graph", desc: "Check tenant password policy" , risk: "read", perms: "Organization.Read.All" },
  { cat: "Tenant Configuration", name: "Get directory sync status", cmd: "Get-MgOrganization | Select OnPremisesSyncEnabled,OnPremisesLastSyncDateTime", module: "Microsoft.Graph", desc: "Check if AAD Connect / Cloud Sync is active" , risk: "read", perms: "Organization.Read.All" },

  // ‚îÄ‚îÄ CONDITIONAL ACCESS (extended) (5 new) ‚îÄ‚îÄ
  { cat: "Conditional Access", name: "Create CA policy (block legacy auth)", cmd: "$params = @{\n  DisplayName = 'Block Legacy Authentication'\n  State = 'enabledForReportingButNotEnforced'\n  Conditions = @{\n    ClientAppTypes = @('exchangeActiveSync','other')\n    Applications = @{ IncludeApplications = @('All') }\n    Users = @{ IncludeUsers = @('All') }\n  }\n  GrantControls = @{ Operator = 'OR'; BuiltInControls = @('block') }\n}\nNew-MgIdentityConditionalAccessPolicy -BodyParameter $params", module: "Microsoft.Graph", desc: "Create a policy to block legacy auth (report-only)" , risk: "modify", perms: "Policy.ReadWrite.ConditionalAccess" },
  { cat: "Conditional Access", name: "Delete CA policy", cmd: 'Remove-MgIdentityConditionalAccessPolicy -ConditionalAccessPolicyId "policy-id" -Confirm:$false', module: "Microsoft.Graph", desc: "Delete a Conditional Access policy" , risk: "destructive", perms: "Policy.ReadWrite.ConditionalAccess" },
  { cat: "Conditional Access", name: "Set CA policy to report-only", cmd: 'Update-MgIdentityConditionalAccessPolicy -ConditionalAccessPolicyId "policy-id" -State "enabledForReportingButNotEnforced"', module: "Microsoft.Graph", desc: "Switch a policy to report-only mode" , risk: "modify", perms: "Policy.ReadWrite.ConditionalAccess" },
  { cat: "Conditional Access", name: "Enable CA policy", cmd: 'Update-MgIdentityConditionalAccessPolicy -ConditionalAccessPolicyId "policy-id" -State "enabled"', module: "Microsoft.Graph", desc: "Enable (enforce) a CA policy" , risk: "modify", perms: "Policy.ReadWrite.ConditionalAccess" },
  { cat: "Conditional Access", name: "Get CA policy sign-in gaps", cmd: "Get-MgReportAuthenticationMethodUserRegistrationDetail | Where { -not $_.IsMfaRegistered } | Select UserPrincipalName,MethodsRegistered", module: "Microsoft.Graph", desc: "Users who may bypass MFA CA policies" , risk: "read", perms: "Policy.Read.All" },

  // ‚îÄ‚îÄ SECURITY & COMPLIANCE (extended) (8 new) ‚îÄ‚îÄ
  { cat: "Security & Compliance", name: "Get PIM eligible role assignments", cmd: "Get-MgRoleManagementDirectoryRoleEligibilityScheduleInstance | Select @{N='Role';E={(Get-MgDirectoryRoleTemplate -DirectoryRoleTemplateId $_.RoleDefinitionId).DisplayName}},PrincipalId,StartDateTime,EndDateTime", module: "Microsoft.Graph", desc: "List PIM eligible role assignments" , risk: "read", perms: "RoleManagement.Read.Directory" },
  { cat: "Security & Compliance", name: "Get PIM active role assignments", cmd: "Get-MgRoleManagementDirectoryRoleAssignmentScheduleInstance -All | Select RoleDefinitionId,PrincipalId,StartDateTime", module: "Microsoft.Graph", desc: "List PIM activated role assignments" , risk: "read", perms: "RoleManagement.Read.Directory" },
  { cat: "Security & Compliance", name: "Get access reviews", cmd: "Get-MgIdentityGovernanceAccessReviewDefinition | Select DisplayName,Status,Scope", module: "Microsoft.Graph", desc: "List access review campaigns" , risk: "read", perms: "AccessReview.Read.All" },
  { cat: "Security & Compliance", name: "Get Safe Links policies", cmd: "Get-SafeLinksPolicy | Select Name,IsEnabled,DoNotRewriteUrls,EnableForInternalSenders", module: "ExchangeOnlineProtection", desc: "Defender for O365 Safe Links config" , risk: "read" },
  { cat: "Security & Compliance", name: "Get Safe Attachments policies", cmd: "Get-SafeAttachmentPolicy | Select Name,Action,Enable,Redirect", module: "ExchangeOnlineProtection", desc: "Defender for O365 Safe Attachments config" , risk: "read" },
  { cat: "Security & Compliance", name: "Get anti-phishing policies", cmd: "Get-AntiPhishPolicy | Select Name,Enabled,EnableMailboxIntelligence,EnableSpoofIntelligence", module: "ExchangeOnlineProtection", desc: "View anti-phishing protection policies" , risk: "read" },
  { cat: "Security & Compliance", name: "Get service principal credentials", cmd: "Get-MgServicePrincipal -All | ForEach { $sp=$_; $_.PasswordCredentials | Select @{N='App';E={$sp.DisplayName}},EndDateTime,DisplayName } | Where { $_.EndDateTime } | Sort EndDateTime", module: "Microsoft.Graph", desc: "Find expiring service principal secrets" , risk: "read", perms: "Application.Read.All" },
  { cat: "Security & Compliance", name: "Get consent grants (admin)", cmd: "Get-MgOauth2PermissionGrant -All -Filter \"consentType eq 'AllPrincipals'\" | Select ClientId,Scope,ConsentType", module: "Microsoft.Graph", desc: "Find admin-consented API permissions" , risk: "read", perms: "Directory.Read.All" },

  // ‚îÄ‚îÄ EXCHANGE ONLINE (extended) (4 new) ‚îÄ‚îÄ
  { cat: "Exchange Online", name: "Get distribution lists", cmd: "Get-DistributionGroup -ResultSize Unlimited | Select DisplayName,PrimarySmtpAddress,ManagedBy", module: "ExchangeOnlineManagement", desc: "List all distribution groups" , risk: "read" },
  { cat: "Exchange Online", name: "Get DL members", cmd: 'Get-DistributionGroupMember -Identity "dl@{{domain}}" | Select DisplayName,PrimarySmtpAddress', module: "ExchangeOnlineManagement", desc: "List members of a distribution list" , risk: "read" },
  { cat: "Exchange Online", name: "Set mailbox archive", cmd: 'Enable-Mailbox -Identity "user@{{domain}}" -Archive', module: "ExchangeOnlineManagement", desc: "Enable online archive for a mailbox" , risk: "modify" },
  { cat: "Exchange Online", name: "Get mailbox archive status", cmd: 'Get-EXOMailbox -ResultSize Unlimited | Select DisplayName,ArchiveStatus,ArchiveQuota | Where { $_.ArchiveStatus -eq "Active" }', module: "ExchangeOnlineManagement", desc: "List mailboxes with active archive" , risk: "read" },

  // ‚îÄ‚îÄ DEVICE MANAGEMENT (extended) (4 new) ‚îÄ‚îÄ
  { cat: "Device Management", name: "Get app protection policies", cmd: "Get-MgDeviceAppManagementManagedAppPolicy | Select DisplayName,@{N='Type';E={$_.AdditionalProperties.'@odata.type'}}", module: "Microsoft.Graph.Intune", desc: "List Intune app protection policies (MAM)" , risk: "read", perms: "Directory.Read.All" },
  { cat: "Device Management", name: "Get detected apps", cmd: "Get-MgDeviceManagementDetectedApp -All | Select DisplayName,Version,DeviceCount | Sort DeviceCount -Descending | Select -First 30", module: "Microsoft.Graph.Intune", desc: "Top 30 detected apps across managed devices" , risk: "read", perms: "Directory.Read.All" },
  { cat: "Device Management", name: "Get Windows Update rings", cmd: "Get-MgDeviceManagementDeviceConfiguration -Filter \"isof('microsoft.graph.windowsUpdateForBusinessConfiguration')\" | Select DisplayName,LastModifiedDateTime", module: "Microsoft.Graph.Intune", desc: "List Windows Update for Business ring policies" , risk: "read", perms: "Directory.Read.All" },
  { cat: "Device Management", name: "Get Autopilot profiles", cmd: "Get-MgDeviceManagementWindowsAutopilotDeploymentProfile | Select DisplayName,Description,Language", module: "Microsoft.Graph.Intune", desc: "List Autopilot deployment profiles" , risk: "read", perms: "DeviceManagementServiceConfig.Read.All" },

  // ‚îÄ‚îÄ REPORTS & AUDITING (extended) (3 new) ‚îÄ‚îÄ
  { cat: "Reports & Auditing", name: "Get Yammer activity report", cmd: "Get-MgReportYammerActivityUserDetail -Period 'D30' -OutFile 'YammerActivity.csv'", module: "Microsoft.Graph", desc: "Yammer/Viva Engage activity per user" , risk: "read", perms: "Reports.Read.All" },
  { cat: "Reports & Auditing", name: "Get Groups activity report", cmd: "Get-MgReportOffice365GroupsActivityDetail -Period 'D30' -OutFile 'GroupsActivity.csv'", module: "Microsoft.Graph", desc: "M365 Groups activity and usage" , risk: "read", perms: "Group.Read.All" },
  { cat: "Reports & Auditing", name: "Get browser usage report", cmd: "Get-MgReportBrowserUserDetail -Period 'D30' -OutFile 'BrowserUsage.csv'", module: "Microsoft.Graph", desc: "Browser distribution for M365 access" , risk: "read", perms: "Reports.Read.All" },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let expandedId = null;
let builderMode = false;
let selectedCmds = new Set();
let favorites = JSON.parse(localStorage.getItem('m365_favs') || '[]');
let activeFilter = 'All';
let activeWorkflow = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

function applyParams(text) {
  const d = document.getElementById('paramDomain').value || 'domain.com';
  const a = document.getElementById('paramAdmin').value || ('admin@' + d);
  const s = document.getElementById('paramSPO').value || (d.split('.')[0] + '-admin.sharepoint.com');
  return text.replace(/\{\{domain\}\}/g, d).replace(/\{\{admin\}\}/g, a).replace(/\{\{spo\}\}/g, s);
}

const svgCopy = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
const svgCheck = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>';
const svgStar = '<svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
const svgStarFill = '<svg width="14" height="14" viewBox="0 0 24 24" stroke="#f59e0b" stroke-width="2" fill="#f59e0b"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';

const RISK_LABELS = { read: 'Read', modify: 'Modify', destructive: 'Destructive' };
function riskBadge(risk) {
  if (!risk) return '';
  return `<span class="risk-badge risk-${risk}"><span class="risk-dot"></span>${RISK_LABELS[risk]}</span>`;
}

let _cc = 0;
function cb(text, label='Copy') {
  const id = 'cb'+(_cc++);
  const escaped = text.replace(/\\/g,'\\\\').replace(/`/g,'\\`').replace(/\$/g,'\\$');
  return `<button class="cb" id="${id}" onclick="event.stopPropagation();doCopy(\`${escaped}\`,'${id}')">${svgCopy} ${label}</button>`;
}

function doCopy(text, btnId) {
  navigator.clipboard.writeText(text);
  const b = document.getElementById(btnId);
  if(b){ b.classList.add('copied'); b.innerHTML=svgCheck+' Copied!'; setTimeout(()=>{b.classList.remove('copied');b.innerHTML=svgCopy+' Copy';},1500); }
}

function saveFavs() { localStorage.setItem('m365_favs', JSON.stringify(favorites)); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SIDEBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildSidebar() {
  const nav = document.getElementById('sidebarNav');
  document.getElementById('sidebarSub').textContent = `${COMMANDS.length} commands ¬∑ ${Object.keys(MODULES).length} modules`;

  let h = `<div class="nav-section-title">Views</div>`;
  h += navItem('All', 'All Commands', COMMANDS.length);
  h += navItem('Favorites', '‚≠ê Favorites', favorites.length);

  h += `<div class="nav-section-title">Workflows</div>`;
  Object.entries(WORKFLOWS).forEach(([id, wf]) => {
    h += navItem(id, wf.name, wf.commands.length);
  });

  h += `<div class="nav-section-title">Categories</div>`;
  CATEGORIES.forEach(c => {
    const cnt = COMMANDS.filter(x => x.cat === c).length;
    h += navItem(c, c, cnt);
  });

  h += `<div class="nav-section-title">By Module</div>`;
  Object.entries(MODULES).forEach(([name, mod]) => {
    const cnt = COMMANDS.filter(x => x.module === name).length;
    if(cnt > 0) h += navItem('mod:'+name, `<span style="color:${mod.color}">${mod.short}</span> ${name.split('.').pop()}`, cnt);
  });

  nav.innerHTML = h;
  highlightNav();
}

function navItem(id, label, cnt) {
  return `<div class="nav-item" data-nav="${id}" onclick="setFilter('${id}')">${label}<span class="cnt">${cnt}</span></div>`;
}

function highlightNav() {
  document.querySelectorAll('.nav-item').forEach(el => {
    el.classList.toggle('active', el.dataset.nav === activeFilter);
  });
}

function setFilter(id) {
  activeFilter = id;
  activeWorkflow = WORKFLOWS[id] || null;
  expandedId = null;
  document.getElementById('searchInput').value = '';
  highlightNav();
  renderCommands();
  updateUrlParams();
}

function jumpToCommand(name) {
  // Find the command and expand it
  document.getElementById('searchInput').value = name;
  activeFilter = 'All';
  activeWorkflow = null;
  highlightNav();
  
  // Find the exact command
  const filtered = COMMANDS.filter(c => c.name === name);
  if(filtered.length > 0) {
    const c = filtered[0];
    const cat = c.cat;
    const idx = COMMANDS.filter(x => x.cat === cat).indexOf(c);
    expandedId = cat + '-' + idx;
  }
  renderCommands();
  
  // Scroll to expanded card
  setTimeout(() => {
    const expanded = document.querySelector('.cmd-card.expanded');
    if(expanded) expanded.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODULE PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildModulePanel() {
  const p = document.getElementById('modulePanel');
  const all = Object.values(MODULES).filter(m=>!m.install.startsWith('#')).map(m=>m.install).join('\n');
  let h = `<h3>Module Installation & Connection</h3><p class="sub">Run in an elevated PowerShell 7 session.</p>`;
  h += `<div class="mod-card"><div class="mod-card-header"><span class="mod-card-name" style="color:var(--accent)">Install All Modules</span>${cb(all,'Copy All')}</div><pre>${esc(all)}</pre></div>`;
  Object.entries(MODULES).forEach(([n,m]) => {
    const docBtn = m.docs ? `<a href="${m.docs}" target="_blank" class="doc-link"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg> Docs</a>` : '';
    h += `<div class="mod-card" style="border-left:3px solid ${m.color}"><div class="mod-card-header"><span class="mod-card-name" style="color:${m.color}">${m.short} <span class="dim">‚Äî ${n}</span></span>${docBtn}</div><div class="mod-btns">${cb(applyParams(m.install),'Install')} ${cb(applyParams(m.connect),'Connect')} ${m.disconnect?cb(m.disconnect,'Disconnect'):''}</div></div>`;
  });
  p.innerHTML = h;
}

function toggleModulePanel() {
  document.getElementById('modulePanel').classList.toggle('visible');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PARAMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleParams() {
  const bar = document.getElementById('paramsBar');
  bar.classList.toggle('visible');
  document.getElementById('paramToggle').classList.toggle('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BUILDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleBuilderMode() {
  builderMode = !builderMode;
  document.getElementById('builderToggle').classList.toggle('active', builderMode);
  document.getElementById('content').classList.toggle('builder-active', builderMode);
  document.getElementById('builderIndicator').classList.toggle('visible', builderMode);
  if(builderMode) { document.getElementById('builderDrawer').classList.add('visible'); }
  else { document.getElementById('builderDrawer').classList.remove('visible'); }
  renderCommands();
}

function toggleBuilderDrawer() {
  document.getElementById('builderDrawer').classList.toggle('visible');
}

function toggleCmdSelection(name, evt) {
  evt.stopPropagation();
  if(selectedCmds.has(name)) selectedCmds.delete(name); else selectedCmds.add(name);
  updateBuilder();
  renderCommands();
}

function clearBuilder() { selectedCmds.clear(); updateBuilder(); renderCommands(); }

function updateBuilder() {
  document.getElementById('builderCount').textContent = selectedCmds.size;
  const badge = document.getElementById('builderBadge');

  if(selectedCmds.size === 0) {
    document.getElementById('builderPreview').textContent = 'No commands selected yet. Enable Script Builder and check commands to include.';
    return;
  }

  const script = generateScript();
  document.getElementById('builderPreview').textContent = script;
}

function generateScript() {
  const cmds = COMMANDS.filter(c => selectedCmds.has(c.name));
  const mods = [...new Set(cmds.map(c => c.module))];

  const safeImport = document.getElementById('optSafeImport').checked;
  const disconnect = document.getElementById('optDisconnect').checked;
  const errorHandling = document.getElementById('optErrorHandling').checked;
  const requiresHeader = document.getElementById('optRequires').checked;
  const transcript = document.getElementById('optTranscript').checked;

  let lines = [];
  
  if(requiresHeader) {
    lines.push('#Requires -Version 7.0');
    lines.push('');
  }

  lines.push('#‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  lines.push('# M365 PowerShell Script');
  lines.push('# Generated: ' + new Date().toISOString().split('T')[0]);
  lines.push('# Commands: ' + cmds.length);
  lines.push('#‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  lines.push('');
  
  if(transcript) {
    lines.push('# ‚îÄ‚îÄ Transcript Logging ‚îÄ‚îÄ');
    lines.push('$transcriptPath = "$env:TEMP\\M365-Script-$(Get-Date -Format yyyyMMdd-HHmmss).log"');
    lines.push('Start-Transcript -Path $transcriptPath -Append');
    lines.push('Write-Host "Transcript started: $transcriptPath" -ForegroundColor Cyan');
    lines.push('');
  }

  lines.push('# ‚îÄ‚îÄ Required Modules ‚îÄ‚îÄ');
  mods.forEach(m => {
    const mod = MODULES[m];
    if(mod && !mod.install.startsWith('#')) {
      if(safeImport) {
        const modName = m.split('.')[0] === 'Microsoft' || m.includes('.') ? m : m;
        lines.push(`if (-not (Get-Module -ListAvailable -Name ${m})) {`);
        lines.push(`    ${applyParams(mod.install)}`);
        lines.push('}');
        lines.push(`Import-Module ${m} -ErrorAction SilentlyContinue`);
      } else {
        lines.push(applyParams(mod.install));
      }
    }
  });
  lines.push('');
  lines.push('# ‚îÄ‚îÄ Connect ‚îÄ‚îÄ');
  const connected = new Set();
  mods.forEach(m => {
    const mod = MODULES[m];
    if(mod && !connected.has(mod.connect)) {
      lines.push(applyParams(mod.connect));
      connected.add(mod.connect);
    }
  });
  lines.push('');

  if(errorHandling) {
    lines.push('try {');
    lines.push('');
  }

  let lastCat = '';
  cmds.forEach(c => {
    if(c.cat !== lastCat) {
      lines.push(`# ‚îÄ‚îÄ ${c.cat} ‚îÄ‚îÄ`);
      lastCat = c.cat;
    }
    lines.push(`# ${c.name}: ${c.desc}`);
    const indent = errorHandling ? '    ' : '';
    applyParams(c.cmd).split('\n').forEach(l => lines.push(indent + l));
    lines.push('');
  });

  if(errorHandling) {
    lines.push('} catch {');
    lines.push('    Write-Error "Script failed: $_"');
    lines.push('    Write-Error $_.ScriptStackTrace');
    lines.push('}');
    if(disconnect || transcript) lines.push('finally {');
  }

  if(disconnect) {
    if(!errorHandling) lines.push('# ‚îÄ‚îÄ Disconnect ‚îÄ‚îÄ');
    const prefix = errorHandling ? '    ' : '';
    const disconnected = new Set();
    mods.forEach(m => {
      const mod = MODULES[m];
      if(mod && mod.disconnect && !disconnected.has(mod.disconnect)) {
        lines.push(prefix + mod.disconnect);
        disconnected.add(mod.disconnect);
      }
    });
  }

  if(transcript) {
    const prefix = errorHandling ? '    ' : '';
    lines.push(prefix + 'Stop-Transcript');
  }

  if(errorHandling && (disconnect || transcript)) {
    lines.push('}');
  }

  return lines.join('\n');
}

function downloadScript() {
  if(selectedCmds.size === 0) return;
  const script = generateScript();
  const blob = new Blob([script], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'M365-Script-' + new Date().toISOString().split('T')[0] + '.ps1';
  a.click();
}

function copyScript() {
  if(selectedCmds.size === 0) return;
  navigator.clipboard.writeText(generateScript());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onSearch() { expandedId = null; activeFilter = 'All'; activeWorkflow = null; highlightNav(); renderCommands(); updateUrlParams(); }

function getFiltered() {
  const q = document.getElementById('searchInput').value.toLowerCase();

  let pool = COMMANDS;

  // Workflow filter
  if(activeWorkflow) {
    pool = COMMANDS.filter(c => activeWorkflow.commands.includes(c.name));
  }
  // Favorites
  else if(activeFilter === 'Favorites') {
    pool = COMMANDS.filter(c => favorites.includes(c.name));
  }
  // Category
  else if(CATEGORIES.includes(activeFilter)) {
    pool = COMMANDS.filter(c => c.cat === activeFilter);
  }
  // Module
  else if(activeFilter.startsWith('mod:')) {
    const m = activeFilter.slice(4);
    pool = COMMANDS.filter(c => c.module === m);
  }

  if(!q) return pool;
  return pool.filter(c =>
    c.name.toLowerCase().includes(q) ||
    c.cmd.toLowerCase().includes(q) ||
    c.desc.toLowerCase().includes(q) ||
    c.module.toLowerCase().includes(q)
  );
}

function renderCommands() {
  _cc = 0;
  const filtered = getFiltered();
  const container = document.getElementById('commandsContainer');

  // Workflow banner
  const wb = document.getElementById('workflowBanner');
  if(activeWorkflow) {
    wb.classList.add('visible');
    wb.innerHTML = `<h3>${activeWorkflow.name}</h3><p>${activeWorkflow.desc}</p><div class="workflow-steps">${activeWorkflow.steps.map((s,i)=>`<div class="workflow-step"><div class="workflow-step-num">${i+1}</div><div class="workflow-step-text">${s}</div></div>`).join('')}</div>`;
  } else {
    wb.classList.remove('visible');
  }

  if(filtered.length === 0) {
    container.innerHTML = `<div class="empty"><div class="icon">üîç</div><div class="title">No commands found</div><div class="sub">Try a different search or filter</div></div>`;
    return;
  }

  const grouped = {};
  filtered.forEach(c => { if(!grouped[c.cat]) grouped[c.cat]=[]; grouped[c.cat].push(c); });

  let html = '';
  Object.entries(grouped).forEach(([cat, cmds]) => {
    html += `<div class="cat-section"><h2 class="cat-title">${cat}<span class="cnt">${cmds.length}</span></h2>`;
    cmds.forEach((c,i) => {
      const id = cat+'-'+i;
      const mod = MODULES[c.module] || {color:'#475569',short:'?'};
      const exp = expandedId === id;
      const isFav = favorites.includes(c.name);
      const isSel = selectedCmds.has(c.name);
      const cmdText = applyParams(c.cmd);

      html += `<div class="cmd-card${exp?' expanded':''}${isFav?' favorited':''}" style="border-left-color:${mod.color}">`;
      html += `<div class="cmd-header" onclick="toggleCard('${id}')">`;

      // Checkbox (builder mode)
      html += `<div class="cmd-check${isSel?' checked':''}${builderMode?'':' hidden'}" onclick="toggleCmdSelection('${c.name.replace(/'/g,"\\'")}',event)">${isSel?svgCheck:''}</div>`;

      // Fav
      html += `<button class="fav-btn${isFav?' active':''}" onclick="event.stopPropagation();toggleFav('${c.name.replace(/'/g,"\\'")}')" title="Toggle favorite">${isFav?svgStarFill:svgStar}</button>`;

      html += `<svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>`;
      html += `<div class="cmd-info"><div class="cmd-name-row"><span class="cmd-name">${esc(c.name)}</span><span class="cmd-badge" style="background:${mod.color}18;color:${mod.color};border:1px solid ${mod.color}33">${mod.short}</span>${riskBadge(c.risk)}</div><div class="cmd-desc">${esc(c.desc)}</div></div>`;

      if(!exp) html += cb(cmdText);
      html += `</div>`;

      // Detail
      html += `<div class="cmd-detail"><div class="cmd-code"><span class="copy-float">${cb(cmdText)}</span>${esc(cmdText)}</div>`;
      html += `<div class="cmd-mod-row"><span class="lbl">Module:</span><code style="color:${mod.color}">${c.module}</code>${cb(applyParams(mod.install),'Install')} ${cb(applyParams(mod.connect),'Connect')}${mod.docs?` <a href="${mod.docs}" target="_blank" class="doc-link"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg> Docs</a>`:''}</div>`;

      // Permissions
      if(c.perms) {
        html += `<div class="perm-row"><span class="lbl">Permissions:</span>${c.perms.split(',').map(p=>`<span class="perm-tag">${p.trim()}</span>`).join('')}</div>`;
      }

      // CSV Template
      if(c.csv) {
        html += `<div style="margin-top:8px"><button class="csv-btn" onclick="event.stopPropagation();downloadCsvTemplate('${esc(c.name)}','${c.csv}')">üì• CSV Template <span style="opacity:0.7;font-size:10px">(${c.csv.split(',').length} columns)</span></button></div>`;
      }

      // Related commands
      if(c.related && c.related.length > 0) {
        html += `<div class="related-row"><span class="lbl">üîó Related commands</span>`;
        c.related.forEach(r => {
          html += `<span class="related-chip" onclick="event.stopPropagation();jumpToCommand('${r.replace(/'/g,"\\'")}')">${esc(r)}</span>`;
        });
        html += `</div>`;
      }

      // Copy as full script
      const fullScript = `# ${c.name}\n${applyParams(mod.install)}\n${applyParams(mod.connect)}\n\n${cmdText}\n\n${mod.disconnect||''}`;
      html += `<div style="margin-top:6px">${cb(fullScript,'Copy as Full Script (Install + Connect + Command)')}</div>`;
      html += `</div></div>`;
    });
    html += '</div>';
  });

  container.innerHTML = html;
  updateBuilder();
}

function toggleCard(id) { expandedId = expandedId===id?null:id; renderCommands(); }

function toggleFav(name) {
  const idx = favorites.indexOf(name);
  if(idx>=0) favorites.splice(idx,1); else favorites.push(name);
  saveFavs();
  buildSidebar();
  renderCommands();
}

function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  const main = document.getElementById('main');
  sb.classList.toggle('visible');
  sb.classList.toggle('hidden');
  main.classList.toggle('full');
  document.getElementById('builderDrawer').classList.toggle('full-width');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleGuide() {
  const toggle = document.getElementById('guideToggle');
  const panel = document.getElementById('guidePanel');
  toggle.classList.toggle('open');
  panel.classList.toggle('visible');
}

function switchGuideTab(tabId, btn) {
  document.querySelectorAll('.guide-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.guide-tab-content').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + tabId).classList.add('active');
}

function togglePortals() {
  const toggle = document.getElementById('portalsToggle');
  const panel = document.getElementById('portalsPanel');
  toggle.classList.toggle('open');
  panel.classList.toggle('visible');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  THEME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const next = current === 'light' ? 'dark' : 'light';
  html.setAttribute('data-theme', next);
  localStorage.setItem('m365_theme', next);
  document.getElementById('themeToggle').textContent = next === 'light' ? '‚òÄÔ∏è' : 'üåô';
}

function loadTheme() {
  const saved = localStorage.getItem('m365_theme') || 'dark';
  if(saved === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TENANT PROFILES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getProfiles() {
  try { return JSON.parse(localStorage.getItem('m365_profiles') || '{}'); } catch(e) { return {}; }
}

function refreshProfiles() {
  const sel = document.getElementById('profileSelect');
  const profiles = getProfiles();
  const current = sel.value;
  sel.innerHTML = '<option value="">‚Äî Select tenant ‚Äî</option>';
  Object.keys(profiles).sort().forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = 'üè¢ ' + name;
    sel.appendChild(opt);
  });
  if(current && profiles[current]) sel.value = current;
}

function saveProfile() {
  const domain = document.getElementById('paramDomain').value.trim();
  const admin = document.getElementById('paramAdmin').value.trim();
  const spo = document.getElementById('paramSPO').value.trim();
  if(!domain) { alert('Enter a domain first.'); return; }
  
  const name = prompt('Profile name (e.g. client name):', domain.split('.')[0].toUpperCase());
  if(!name) return;
  
  const profiles = getProfiles();
  profiles[name] = { domain, admin, spo };
  localStorage.setItem('m365_profiles', JSON.stringify(profiles));
  refreshProfiles();
  document.getElementById('profileSelect').value = name;
}

function loadProfile() {
  const sel = document.getElementById('profileSelect');
  const profiles = getProfiles();
  const profile = profiles[sel.value];
  if(!profile) return;
  
  document.getElementById('paramDomain').value = profile.domain || '';
  document.getElementById('paramAdmin').value = profile.admin || '';
  document.getElementById('paramSPO').value = profile.spo || '';
  renderCommands();
}

function deleteProfile() {
  const sel = document.getElementById('profileSelect');
  if(!sel.value) { alert('Select a profile first.'); return; }
  if(!confirm('Delete profile "' + sel.value + '"?')) return;
  
  const profiles = getProfiles();
  delete profiles[sel.value];
  localStorage.setItem('m365_profiles', JSON.stringify(profiles));
  sel.value = '';
  refreshProfiles();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  URL DEEP LINKS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function readUrlParams() {
  const params = new URLSearchParams(window.location.search);
  if(params.get('filter')) {
    const f = params.get('filter');
    // Check if it's a workflow, category, module, or special view
    if(WORKFLOWS[f]) { activeFilter = f; activeWorkflow = WORKFLOWS[f]; }
    else if(f === 'Favorites') { activeFilter = 'Favorites'; }
    else if(CATEGORIES.includes(f)) { activeFilter = f; }
    else if(f.startsWith('mod:')) { activeFilter = f; }
    else { activeFilter = f; }
  }
  if(params.get('search')) {
    document.getElementById('searchInput').value = params.get('search');
    activeFilter = 'All';
  }
}

function updateUrlParams() {
  const params = new URLSearchParams();
  const q = document.getElementById('searchInput').value;
  if(q) params.set('search', q);
  else if(activeFilter && activeFilter !== 'All') params.set('filter', activeFilter);
  
  const newUrl = params.toString() ? '?' + params.toString() : window.location.pathname;
  history.replaceState(null, '', newUrl);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CSV TEMPLATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function downloadCsvTemplate(name, columns) {
  const bom = '\uFEFF';
  const csv = bom + columns + '\n' + columns.split(',').map(c => '').join(',') + '\n';
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name.replace(/[^a-zA-Z0-9]/g, '-') + '-template.csv';
  a.click();
}

document.addEventListener('DOMContentLoaded', () => {
  loadTheme();
  refreshProfiles();
  readUrlParams();
  buildSidebar();
  buildModulePanel();
  highlightNav();
  renderCommands();

  // Keyboard shortcut: Ctrl+K to focus search
  document.addEventListener('keydown', (e) => {
    if((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      document.getElementById('searchInput').focus();
    }
    // Escape to close guide / blur search
    if(e.key === 'Escape') {
      document.getElementById('searchInput').blur();
      document.getElementById('guidePanel').classList.remove('visible');
      document.getElementById('guideToggle').classList.remove('open');
      document.getElementById('portalsPanel').classList.remove('visible');
      document.getElementById('portalsToggle').classList.remove('open');
    }
  });

  // Responsive: hide sidebar by default on mobile
  if(window.innerWidth <= 860) {
    document.getElementById('sidebar').classList.add('hidden');
    document.getElementById('main').classList.add('full');
  }
});
</script>
</body>
</html>
